# User Flow
# WorkFlow - 사용자 행동 흐름 정의

**버전:** 1.0  
**작성일:** 2026-02-02  
**작성자:** UX Team  
**문서 상태:** Draft

---

## 목차

1. [문서 개요](#1-문서-개요)
2. [근로자 User Flow](#2-근로자-user-flow)
3. [관리자 User Flow](#3-관리자-user-flow)
4. [시스템 통합 Flow](#4-시스템-통합-flow)
5. [예외 상황 Flow](#5-예외-상황-flow)

---

## 1. 문서 개요

### 1.1 문서 목적
본 문서는 WorkFlow 시스템의 주요 사용자 행동 흐름을 시각화하여, UX/UI 디자인과 개발 구현의 기준을 제공한다.

### 1.2 User Flow 범위
- 근로자의 출퇴근 체크인/체크아웃
- 관리자의 근태 모니터링 및 급여 처리
- 예외 상황 처리 (GPS 실패, 네트워크 오류 등)

### 1.3 표기 규칙
- 📱 = 모바일 앱 (근로자)
- 💻 = 웹 대시보드 (관리자)
- 🔧 = 시스템 처리
- ❌ = 오류 처리
- ✅ = 성공 처리

---

## 2. 근로자 User Flow

### 2.1 회원가입 및 로그인

```mermaid
flowchart TD
    A[앱 최초 실행] --> B{로그인 필요}
    B -->|Yes| C[전화번호 입력]
    C --> D[SMS 인증번호 발송]
    D --> E[인증번호 입력]
    E --> F{인증 성공?}
    F -->|No| G[오류 메시지 표시]
    G --> E
    F -->|Yes| H[사용자 정보 확인]
    H --> I{등록된 근로자?}
    I -->|No| J[관리자에게 등록 요청 안내]
    J --> K[종료]
    I -->|Yes| L[로그인 완료]
    L --> M[메인 화면 진입]
    
    B -->|No| M
```

**상세 설명:**

1. **앱 최초 실행**
   - 스플래시 화면 표시 (1초)
   - 로그인 상태 확인

2. **전화번호 입력**
   - 국가 코드 자동 선택 (+82)
   - 숫자만 입력 가능
   - 하이픈 자동 포맷팅

3. **SMS 인증**
   - 6자리 인증번호 발송
   - 유효 시간: 3분
   - 재발송 가능 (1분 후)

4. **사용자 확인**
   - DB에서 전화번호로 근로자 조회
   - 미등록 시 관리자 연락처 안내

---

### 2.2 출근 체크인

```mermaid
flowchart TD
    A[메인 화면] --> B[출근 버튼 탭]
    B --> C[위치 권한 확인]
    C --> D{권한 허용?}
    D -->|No| E[권한 요청 다이얼로그]
    E --> F{권한 승인?}
    F -->|No| G[권한 필요 안내]
    G --> A
    F -->|Yes| H[GPS 위치 수집]
    D -->|Yes| H
    
    H --> I{GPS 정확도 OK?}
    I -->|No| J[정확도 낮음 경고]
    J --> K[재시도 or 취소]
    K --> H
    
    I -->|Yes| L[사업장과 거리 계산]
    L --> M{반경 100m 이내?}
    M -->|No| N[위치 오류 메시지]
    N --> O[관리자 문의 안내]
    O --> A
    
    M -->|Yes| P[DB에 출근 기록 저장]
    P --> Q[성공 피드백]
    Q --> R[출근 시간 표시]
    R --> S[근무 중 화면]
```

**상세 설명:**

1. **메인 화면 구성**
   - 상단: 사용자 이름, 사업장명
   - 중앙: 큰 "출근" 버튼 (초록색)
   - 하단: 최근 출퇴근 기록

2. **GPS 위치 수집**
   - Geolocator 패키지 사용
   - 정확도 < 50m 요구
   - 타임아웃: 10초

3. **거리 계산**
   - Haversine 공식 사용
   - 사업장 GPS 좌표와 비교
   - 허용 반경: 100m

4. **성공 피드백**
   - 진동 (200ms)
   - "출근이 완료되었습니다 ✓"
   - 출근 시간 표시 (HH:MM:SS)

---

### 2.3 퇴근 체크아웃

```mermaid
flowchart TD
    A[근무 중 화면] --> B[퇴근 버튼 탭]
    B --> C{출근 기록 존재?}
    C -->|No| D[출근 기록 없음 오류]
    D --> E[관리자 문의 안내]
    E --> A
    
    C -->|Yes| F[GPS 위치 수집]
    F --> G{GPS 정확도 OK?}
    G -->|No| H[정확도 낮음 경고]
    H --> I[재시도 or 강제 퇴근]
    I -->|재시도| F
    I -->|강제 퇴근| J[관리자 승인 필요 표시]
    
    G -->|Yes| K[사업장과 거리 계산]
    K --> L{반경 100m 이내?}
    L -->|No| M[위치 경고 표시]
    M --> N[계속 or 취소]
    N -->|취소| A
    N -->|계속| O[관리자 승인 필요 표시]
    
    L -->|Yes| P[DB에 퇴근 기록 업데이트]
    P --> Q[근무시간 자동 계산]
    Q --> R[성공 피드백]
    R --> S[퇴근 완료 화면]
    S --> T[오늘 근무 요약 표시]
    T --> U[메인 화면 복귀]
```

**상세 설명:**

1. **근무 중 화면**
   - 출근 시간 표시
   - 현재 근무 시간 (실시간 카운트)
   - 퇴근 버튼 (파란색)

2. **퇴근 검증**
   - 출근 기록 존재 확인
   - GPS 위치 재수집
   - 거리 재계산

3. **강제 퇴근 옵션**
   - GPS 오류 시 선택 가능
   - 관리자 승인 필요 표시
   - 메모 입력 가능

4. **근무 요약**
   - 출근 시간, 퇴근 시간
   - 총 근무 시간 (HH:MM 형식)
   - (향후) 예상 급여

---

### 2.4 근태 기록 조회

```mermaid
flowchart TD
    A[메인 화면] --> B[내 근태 메뉴 탭]
    B --> C[이번 달 기록 로딩]
    C --> D[캘린더 뷰 표시]
    D --> E[날짜별 출퇴근 시간]
    E --> F{특정 날짜 선택?}
    F -->|Yes| G[해당 날짜 상세 화면]
    G --> H[출근/퇴근 시간, 근무시간 표시]
    H --> I[GPS 위치 지도 표시]
    I --> J[뒤로 가기]
    J --> D
    
    F -->|No| K[월 선택 변경?]
    K -->|Yes| L[이전/다음 달 선택]
    L --> M[해당 월 기록 로딩]
    M --> D
    K -->|No| N[메인 화면 복귀]
```

**상세 설명:**

1. **캘린더 뷰**
   - 월간 캘린더 형식
   - 출근 날짜는 초록색 점 표시
   - 결근 날짜는 빨간색 점 표시

2. **상세 화면**
   - 출근/퇴근 정확한 시간
   - 총 근무 시간
   - GPS 위치 지도 표시 (작은 맵)

3. **월 통계**
   - 총 출근 일수
   - 총 근무 시간
   - (향후) 예상 급여

---

## 3. 관리자 User Flow

### 3.1 로그인 및 대시보드

```mermaid
flowchart TD
    A[웹 브라우저 접속] --> B[로그인 화면]
    B --> C[이메일 + 비밀번호 입력]
    C --> D{인증 성공?}
    D -->|No| E[오류 메시지 표시]
    E --> C
    
    D -->|Yes| F[사용자 권한 확인]
    F --> G{관리자 권한?}
    G -->|No| H[접근 거부 메시지]
    H --> B
    
    G -->|Yes| I[대시보드 로딩]
    I --> J[오늘 출근 현황 조회]
    J --> K[실시간 데이터 구독]
    K --> L[대시보드 표시]
    L --> M[출근 N명 / 전체 M명]
    M --> N[미출근 근로자 목록]
    N --> O[실시간 업데이트 대기]
```

**상세 설명:**

1. **로그인 화면**
   - 이메일 입력
   - 비밀번호 입력 (마스킹)
   - "로그인 유지" 체크박스

2. **권한 확인**
   - DB에서 role = 'manager' 확인
   - 사업장 정보 로딩
   - 근로자 목록 캐싱

3. **대시보드 레이아웃**
   - 상단: 오늘 날짜, 사업장명
   - 중앙: 큰 숫자 (출근 현황)
   - 하단: 미출근 목록 테이블

---

### 3.2 실시간 출퇴근 모니터링

```mermaid
flowchart TD
    A[대시보드] --> B[Realtime 구독 시작]
    B --> C{새 출근 기록?}
    C -->|Yes| D[출근 인원 +1]
    D --> E[미출근 목록 업데이트]
    E --> F[알림 표시]
    F --> G[대시보드 리렌더링]
    G --> C
    
    C -->|No| H{새 퇴근 기록?}
    H -->|Yes| I[퇴근 완료 목록 업데이트]
    I --> J[근무시간 계산 표시]
    J --> C
    
    H -->|No| K[대기]
    K --> C
    
    A --> L[출퇴근 기록 탭 클릭]
    L --> M[날짜 범위 선택]
    M --> N[기록 조회]
    N --> O[테이블 표시]
    O --> P[필터/정렬 적용]
    P --> Q[엑셀 다운로드 옵션]
```

**상세 설명:**

1. **실시간 업데이트**
   - Supabase Realtime 사용
   - attendances 테이블 변경 감지
   - 자동 UI 업데이트 (새로고침 불필요)

2. **출근 현황 카드**
   - 출근 완료 (초록색)
   - 근무 중 (파란색)
   - 퇴근 완료 (회색)
   - 미출근 (빨간색)

3. **상세 기록 테이블**
   - 컬럼: 이름, 파트, 출근시간, 퇴근시간, 근무시간
   - 정렬: 이름순, 시간순
   - 필터: 파트별, 상태별

---

### 3.3 근로자 관리

```mermaid
flowchart TD
    A[대시보드] --> B[근로자 관리 메뉴]
    B --> C[근로자 목록 로딩]
    C --> D[테이블 표시]
    D --> E{작업 선택}
    
    E -->|신규 등록| F[등록 폼 표시]
    F --> G[이름, 전화번호, 파트 입력]
    G --> H{유효성 검증}
    H -->|실패| I[오류 메시지]
    I --> G
    H -->|성공| J[DB에 저장]
    J --> K[성공 메시지]
    K --> C
    
    E -->|정보 수정| L[수정 폼 표시]
    L --> M[기존 정보 로딩]
    M --> N[정보 수정]
    N --> O{유효성 검증}
    O -->|실패| P[오류 메시지]
    P --> N
    O -->|성공| Q[DB 업데이트]
    Q --> K
    
    E -->|퇴사 처리| R[확인 다이얼로그]
    R --> S{확인?}
    S -->|No| D
    S -->|Yes| T[is_active = false 설정]
    T --> U[퇴사일 기록]
    U --> K
```

**상세 설명:**

1. **근로자 목록**
   - 검색: 이름, 전화번호
   - 필터: 파트별, 재직/퇴사
   - 정렬: 이름순, 입사일순

2. **등록 폼**
   - 이름 (한글, 2-10자)
   - 전화번호 (하이픈 자동, 중복 체크)
   - 파트 선택 (드롭다운)

3. **유효성 검증**
   - 전화번호 형식 (010-XXXX-XXXX)
   - 전화번호 중복 체크
   - 파트 선택 필수

---

### 3.4 급여대장 생성 및 내보내기

```mermaid
flowchart TD
    A[대시보드] --> B[급여 메뉴 클릭]
    B --> C[년월 선택 UI]
    C --> D[년월 선택]
    D --> E[급여대장 생성 버튼]
    E --> F{이미 생성됨?}
    F -->|Yes| G[기존 급여대장 로딩]
    G --> H[급여대장 테이블 표시]
    
    F -->|No| I[Supabase Edge Function 호출]
    I --> J[해당 월 출퇴근 기록 조회]
    J --> K[근로자별 집계]
    K --> L[총 근무시간 계산]
    L --> M[파트별 시급 조회]
    M --> N[급여 계산]
    N --> O[급여대장 데이터 생성]
    O --> P[DB에 저장]
    P --> H
    
    H --> Q[검토 및 수정]
    Q --> R{수정 필요?}
    R -->|Yes| S[수동 수정]
    S --> T[DB 업데이트]
    T --> H
    
    R -->|No| U[엑셀 내보내기 버튼]
    U --> V[Excel 패키지로 파일 생성]
    V --> W[컬럼 설정]
    W --> X[데이터 삽입]
    X --> Y[스타일 적용]
    Y --> Z[파일 다운로드]
    Z --> AA[완료 메시지]
```

**상세 설명:**

1. **년월 선택**
   - 월 선택기 (드롭다운)
   - 기본값: 이전 달
   - 미래 월 선택 불가

2. **급여 계산 로직**
   ```
   FOR EACH 근로자:
     총 근무시간 = SUM(퇴근시간 - 출근시간)
     파트 조회 → 시급
     기본급 = 시급 × 총 근무시간
   ```

3. **급여대장 테이블**
   - 컬럼: 이름, 파트, 출근일수, 총 근무시간, 기본급
   - 합계 행 추가
   - 정렬: 이름순

4. **엑셀 내보내기**
   - 파일명: `급여대장_YYYY-MM_사업장명.xlsx`
   - 시트명: "급여대장"
   - 헤더 볼드 처리
   - 금액 천 단위 콤마

---

## 4. 시스템 통합 Flow

### 4.1 전체 데이터 흐름

```mermaid
flowchart LR
    A[근로자 앱] -->|출근 체크인| B[Supabase API]
    B -->|GPS + 시간 저장| C[PostgreSQL DB]
    C -->|Realtime 트리거| D[WebSocket]
    D -->|실시간 전송| E[관리자 웹]
    E -->|대시보드 업데이트| F[UI 리렌더링]
    
    A -->|퇴근 체크아웃| B
    B -->|근무시간 계산| C
    C -->|Trigger 실행| G[work_hours 자동 계산]
    G -->|업데이트| C
    
    E -->|급여대장 생성 요청| H[Edge Function]
    H -->|집계 쿼리| C
    C -->|집계 결과| H
    H -->|급여 계산| I[JSON 데이터]
    I -->|반환| E
    E -->|엑셀 생성| J[클라이언트 다운로드]
```

---

### 4.2 GPS 검증 Flow

```mermaid
flowchart TD
    A[GPS 위치 수집 요청] --> B[Geolocator 시작]
    B --> C{위치 권한?}
    C -->|없음| D[권한 요청]
    D --> E{승인?}
    E -->|No| F[오류 반환]
    E -->|Yes| G[위치 수집 시도]
    C -->|있음| G
    
    G --> H{타임아웃 10초}
    H -->|시간 초과| I[타임아웃 오류]
    I --> F
    
    H -->|성공| J[위치 데이터 획득]
    J --> K{정확도 < 50m?}
    K -->|No| L[정확도 낮음 경고]
    L --> M[재시도 or 포기]
    M -->|재시도| G
    M -->|포기| F
    
    K -->|Yes| N[사업장 좌표 조회]
    N --> O[Haversine 거리 계산]
    O --> P{거리 < 100m?}
    P -->|No| Q[위치 오류 반환]
    Q --> F
    
    P -->|Yes| R[검증 성공]
    R --> S[출퇴근 기록 저장]
```

---

## 5. 예외 상황 Flow

### 5.1 네트워크 오류 처리

```mermaid
flowchart TD
    A[출퇴근 버튼 탭] --> B[API 호출]
    B --> C{네트워크 연결?}
    C -->|No| D[로컬 저장소에 임시 저장]
    D --> E[오프라인 모드 안내]
    E --> F[백그라운드 동기화 대기]
    F --> G{네트워크 복구?}
    G -->|Yes| H[로컬 데이터 동기화]
    H --> I[서버에 전송]
    I --> J{전송 성공?}
    J -->|Yes| K[로컬 데이터 삭제]
    K --> L[동기화 완료 알림]
    J -->|No| M[재시도 큐에 추가]
    M --> F
    G -->|No| F
    
    C -->|Yes| N[정상 처리]
```

**상세 설명:**

1. **로컬 저장**
   - SharedPreferences 사용
   - 최대 10개 기록 보관
   - 타임스탬프 포함

2. **백그라운드 동기화**
   - ConnectivityPlus 패키지로 네트워크 감지
   - 자동 재시도 (1분, 5분, 10분 간격)
   - 최대 3회 시도

3. **사용자 안내**
   - "오프라인 모드입니다. 출퇴근 기록이 임시 저장되었습니다."
   - "네트워크 연결 시 자동으로 동기화됩니다."

---

### 5.2 GPS 오류 처리

```mermaid
flowchart TD
    A[GPS 수집 실패] --> B{오류 유형}
    B -->|권한 거부| C[권한 필요 안내]
    C --> D[설정 화면 이동 옵션]
    D --> E{설정 이동?}
    E -->|Yes| F[앱 설정 열기]
    E -->|No| G[종료]
    
    B -->|위치 서비스 꺼짐| H[위치 서비스 활성화 안내]
    H --> I[시스템 설정 이동]
    
    B -->|정확도 낮음| J[재시도 안내]
    J --> K[3회 재시도]
    K --> L{성공?}
    L -->|Yes| M[정상 처리]
    L -->|No| N[수동 기록 옵션]
    N --> O[관리자 승인 필요 표시]
    O --> P[메모 입력]
    P --> Q[임시 저장]
    
    B -->|사업장 반경 밖| R[위치 오류 메시지]
    R --> S[현재 위치 지도 표시]
    S --> T[관리자 문의 안내]
```

---

### 5.3 중복 체크인 방지

```mermaid
flowchart TD
    A[출근 버튼 탭] --> B[오늘 날짜 확인]
    B --> C{오늘 출근 기록 존재?}
    C -->|Yes| D[중복 체크인 방지]
    D --> E[경고 메시지]
    E --> F["이미 출근하셨습니다"]
    F --> G[출근 시간 표시]
    G --> H[확인 버튼]
    H --> I[메인 화면]
    
    C -->|No| J[정상 체크인 진행]
    J --> K[GPS 수집]
    K --> L[DB 저장]
    
    A2[퇴근 버튼 탭] --> B2{오늘 출근 기록?}
    B2 -->|No| C2[출근 기록 없음 오류]
    C2 --> D2[출근 먼저 필요 안내]
    D2 --> I
    
    B2 -->|Yes| E2{이미 퇴근?}
    E2 -->|Yes| F2[중복 퇴근 방지]
    F2 --> G2["이미 퇴근하셨습니다"]
    G2 --> H2[퇴근 시간 표시]
    H2 --> I
    
    E2 -->|No| J2[정상 퇴근 진행]
```

---

### 5.4 관리자 승인 Flow (Post-MVP)

```mermaid
flowchart TD
    A[근로자: GPS 오류 발생] --> B[수동 기록 요청]
    B --> C[사유 입력]
    C --> D[임시 저장]
    D --> E[관리자에게 알림]
    
    E --> F[관리자: 승인 대기 목록 확인]
    F --> G[요청 상세 확인]
    G --> H[근로자 정보, 시간, 사유]
    H --> I{승인 결정}
    
    I -->|승인| J[출퇴근 기록 생성]
    J --> K[근로자에게 알림]
    K --> L[완료]
    
    I -->|거부| M[거부 사유 입력]
    M --> N[근로자에게 알림]
    N --> O[재요청 또는 포기]
```

---

## 부록

### A. 화면 전환 매트릭스

| 현재 화면 | 액션 | 다음 화면 |
|---------|-----|---------|
| 스플래시 | 자동 (1초) | 로그인 or 메인 |
| 로그인 | 인증 성공 | 메인 |
| 메인 | 출근 버튼 | 출근 중 |
| 출근 중 | 퇴근 버튼 | 퇴근 완료 |
| 퇴근 완료 | 확인 버튼 | 메인 |
| 메인 | 내 근태 메뉴 | 근태 기록 |
| 근태 기록 | 뒤로 가기 | 메인 |

### B. 에러 메시지 가이드

| 에러 코드 | 메시지 | 액션 |
|---------|-------|------|
| GPS_PERMISSION_DENIED | "위치 권한이 필요합니다" | 설정 이동 |
| GPS_TIMEOUT | "위치를 찾을 수 없습니다" | 재시도 |
| GPS_LOW_ACCURACY | "GPS 정확도가 낮습니다" | 재시도 or 수동 |
| OUT_OF_RANGE | "사업장 반경을 벗어났습니다" | 위치 확인 |
| NETWORK_ERROR | "네트워크 연결을 확인하세요" | 재시도 |
| ALREADY_CHECKED_IN | "이미 출근하셨습니다" | 확인 |
| NO_CHECK_IN_RECORD | "출근 기록이 없습니다" | 관리자 문의 |

### C. 성능 목표

| Flow | 단계 | 목표 시간 |
|-----|-----|---------|
| 출근 체크인 | 버튼 탭 → 완료 | < 2초 |
| 퇴근 체크아웃 | 버튼 탭 → 완료 | < 2초 |
| 대시보드 로딩 | 로그인 → 표시 | < 3초 |
| 급여대장 생성 | 요청 → 표시 | < 5초 (50명 기준) |
| 엑셀 다운로드 | 버튼 → 파일 | < 3초 |

---

**문서 승인:**
- [ ] UX Designer
- [ ] Frontend Developer
- [ ] Product Manager

**변경 이력:**
| 버전 | 날짜 | 작성자 | 변경 내용 |
|-----|-----|-------|---------|
| 1.0 | 2026-02-02 | UX Team | 초안 작성 |
