# v1.13 — Supabase 연동 기반 인프라 (Phase 1~2)

## 개요
Supabase DB 테이블 5개가 생성되었으나 Flutter 앱과 실제 연동이 안 되는 상태에서,
JSON 필드명 불일치, RLS 정책 오류, 환경변수 미설정 등 기반 문제를 해결.

---

## Phase 1: DB + 모델 정합성

### 1-1. RLS 정책 수정 (Migration 006)
**문제**: 모든 RLS 정책이 `role = 'manager'`를 검사하지만, 005 마이그레이션에서 역할이 `worker/center_manager/owner/system_admin`으로 변경됨.

**해결**:
- 기존 14개 정책 전부 DROP
- 헬퍼 함수 `get_my_role()`, `get_my_site_id()` 생성 (search_path 보안 적용)
- 새 역할 체계 기반 정책 재생성:
  - `worker`: 자신의 데이터만 조회
  - `center_manager`: 같은 사업장 데이터 조회 + 등록/수정/삭제
  - `owner`/`system_admin`: 전체 데이터 접근
- 트리거 함수(`calculate_work_hours`, `update_updated_at`)에 `SET search_path = public` 추가

**파일**: `supabase/migrations/006_fix_rls_policies_for_new_roles.sql`

### 1-2. worker_profiles 테이블 생성 (Migration 007)
**문제**: Manager Web의 WorkerRow에 20개+ HR 필드가 있으나 DB에는 없음.

**해결**: `worker_profiles` 테이블 생성 (workers와 1:1 관계)
- 필드: company, employee_id, ssn, gender, address, detail_address, email, emergency_contact, resume_file, employment_status, join_date, leave_date, position, title, job, photo_url
- 인덱스: worker_id, employee_id, company
- RLS 정책: 새 역할 체계 기반
- updated_at 트리거 연결

**파일**: `supabase/migrations/007_create_worker_profiles.sql`

### 1-3. Freezed 모델 snake_case 변환
**문제**: DB 컬럼은 `snake_case`(`site_id`), 모델 JSON은 `camelCase`(`siteId`) → fromJson 파싱 실패

**해결**:
- `packages/core/build.yaml` 생성 — `field_rename: snake` 글로벌 설정
- `Worker.siteId`를 `String?`로 변경 (owner/system_admin의 site_id NULL 대응)
- `WorkerProfile` Freezed 모델 신규 생성
- `core.dart`에 export 추가
- `build_runner` 재실행 → 모든 `.g.dart` 파일이 snake_case JSON 키 사용 확인

**수정 파일**:
- `packages/core/build.yaml` (신규)
- `packages/core/lib/src/models/worker.dart` — siteId nullable
- `packages/core/lib/src/models/worker_profile.dart` (신규)
- `packages/core/lib/core.dart` — export 추가

### 1-4. 시드 데이터 삽입 (Migration 008)
기존 데이터: 서이천센터 1개, 지게차 파트 1개

**추가**:
- 센터 3곳: 안성센터, 의왕센터, 부평센터
- 파트 5개: 지게차(야간), 피커, 피커(야간), 검수, 사무

**결과**: 센터 4개 + 파트 6개 완비

**파일**: `supabase/migrations/008_seed_sites_and_parts.sql`

---

## Phase 2: 환경변수 + Supabase 초기화

### 2-1. flutter_dotenv 환경변수 설정
**작업**:
- `flutter_dotenv: ^5.2.1` 양쪽 앱 pubspec.yaml에 추가
- `flutter:` > `assets:` > `- .env` 설정
- `.env` 파일 생성 (SUPABASE_URL + SUPABASE_ANON_KEY 실제 값)
- `.gitignore`에 `.env` 이미 포함 확인

**수정 파일**:
- `apps/manager_web/pubspec.yaml`
- `apps/worker_app/pubspec.yaml`
- `apps/manager_web/.env` (신규, gitignored)
- `apps/worker_app/.env` (신규, gitignored)

### 2-2. main.dart Supabase 초기화
**Manager Web** (`apps/manager_web/lib/main.dart`):
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await dotenv.load();
  await SupabaseService.instance.initialize(
    url: dotenv.env['SUPABASE_URL']!,
    anonKey: dotenv.env['SUPABASE_ANON_KEY']!,
  );
  await initializeDateFormatting('ko');
  runApp(const ProviderScope(child: ManagerApp()));
}
```

**Worker App** (`apps/worker_app/lib/main.dart`):
```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await dotenv.load();
  await SupabaseService.instance.initialize(
    url: dotenv.env['SUPABASE_URL']!,
    anonKey: dotenv.env['SUPABASE_ANON_KEY']!,
  );
  runApp(const ProviderScope(child: WorkerApp()));
}
```

---

## 변경 파일 요약

| 구분 | 파일 | 작업 |
|------|------|------|
| Migration | `supabase/migrations/006_fix_rls_policies_for_new_roles.sql` | RLS 정책 전면 수정 |
| Migration | `supabase/migrations/007_create_worker_profiles.sql` | HR 프로필 테이블 생성 |
| Migration | `supabase/migrations/008_seed_sites_and_parts.sql` | 시드 데이터 삽입 |
| Core | `packages/core/build.yaml` | snake_case JSON 설정 |
| Core | `packages/core/lib/src/models/worker.dart` | siteId nullable |
| Core | `packages/core/lib/src/models/worker_profile.dart` | 신규 모델 |
| Core | `packages/core/lib/core.dart` | export 추가 |
| Manager Web | `apps/manager_web/pubspec.yaml` | flutter_dotenv + assets |
| Manager Web | `apps/manager_web/lib/main.dart` | Supabase 초기화 |
| Manager Web | `apps/manager_web/.env` | 환경변수 (gitignored) |
| Worker App | `apps/worker_app/pubspec.yaml` | flutter_dotenv + assets |
| Worker App | `apps/worker_app/lib/main.dart` | Supabase 초기화 |
| Worker App | `apps/worker_app/.env` | 환경변수 (gitignored) |

---

## 이번 세션에서 하지 않은 것
- Repository 전환 (데모 → Supabase) — Phase 3~6
- Auth 연동 — Phase 3, 5
- Edge Function — Phase 7
- WorkerRow → Core Worker 리팩토링 — 별도 세션
