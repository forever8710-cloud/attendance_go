# v1.14 — Supabase Repository 연동 (Phase 3)

## 개요
v1.13에서 구축한 Supabase 기반 인프라 위에, 실제 Repository들을 Supabase 쿼리로 전환.
Auth 로그인 → Workers 조회까지 실제 DB 데이터가 흐르는 파이프라인 완성.

---

## 작업 내역

### 1. RLS: sites/parts 공개 조회 허용 (Migration 009)
- sites/parts는 공개 참조데이터 → `USING (true)`로 anon/authenticated 모두 SELECT 허용
- 기존 `auth.role() = 'authenticated'` 조건 제거

**파일**: `supabase/migrations/009_allow_anon_select_sites_parts.sql`

### 2. Supabase sites/parts 프로바이더 생성
Supabase에서 실시간 센터/파트 목록을 조회하는 Riverpod 프로바이더 세트:

| Provider | 역할 |
|----------|------|
| `sitesProvider` | Supabase sites 테이블 전체 조회 (FutureProvider) |
| `partsProvider` | Supabase parts 테이블 전체 조회 (FutureProvider) |
| `siteNamesProvider` | 센터 이름 목록 (드롭다운용) |
| `partNamesProvider` | 파트 이름 목록 (드롭다운용) |
| `siteIdByNameProvider` | name → id 매핑 |
| `partIdByNameProvider` | name → id 매핑 |
| `siteNameByIdProvider` | id → name 역매핑 |
| `partNameByIdProvider` | id → name 역매핑 |

**파일**: `apps/manager_web/lib/core/providers/reference_data_provider.dart` (신규)

### 3. 근로자관리 UI — Supabase 드롭다운 연동
- 근로자 등록/수정 폼의 '직무', '사업장' 드롭다운 → `partNamesProvider`, `siteNamesProvider` 사용
- 필터 바의 사업장/직무 필터 → 동일 프로바이더 사용
- 하드코딩된 `CompanyConstants.parts`, `CompanyConstants.centerNames` → Supabase 데이터로 교체

**수정 파일**: `apps/manager_web/lib/features/workers/presentation/workers_screen.dart`

### 4. 테스트 관리자 계정 생성 + Auth 연동
**Supabase Auth 테스트 계정**:
- 이메일: `admin@tkholdings.com`
- 비밀번호: `admin1234`
- 역할: `system_admin`
- workers 테이블 + worker_profiles 테이블에 매핑 완료

**ManagerAuthRepository 전환**:
- `signInWithEmail()`: Supabase `auth.signInWithPassword()` → workers 테이블 조회 → `Worker.fromJson()`
- `signOut()`: Supabase `auth.signOut()`
- `AuthException` 에러 한글 메시지 처리

**수정 파일**:
- `apps/manager_web/lib/features/auth/data/auth_repository.dart`
- `apps/manager_web/lib/features/auth/providers/auth_provider.dart`

### 5. WorkersRepository Supabase 연동
**getWorkers()**:
- `workers` LEFT JOIN `worker_profiles` (Supabase 관계 쿼리)
- `site_id` → site name, `part_id` → part name 자동 매핑 (캐시)
- Supabase 연결 실패 시 빈 목록 반환 (데모 로그인 fallback)

**addWorker()**: site_name → site_id, part_name → part_id 변환 후 INSERT

**saveWorkerProfile()**: workers UPDATE + worker_profiles UPSERT

**deactivateWorker()**: workers UPDATE (is_active = false)

**generateNextEmployeeId()**: worker_profiles에서 LIKE 쿼리 → 다음 순번 계산 (async 전환)

**수정 파일**: `apps/manager_web/lib/features/workers/data/workers_repository.dart`

---

## 데이터 흐름 (v1.14)

```
[로그인 화면]
  ├─ 이메일/비밀번호 입력
  │   → Supabase Auth signInWithPassword()
  │   → workers 테이블에서 role 조회
  │   → AuthState(authenticated, worker, role)
  │
  └─ 데모 로그인 버튼 (기존 유지)
      → 인메모리 데모 Worker 객체
      → AuthState(authenticated, demoWorker, role)

[근로자관리 화면]
  ├─ 드롭다운 (사업장/파트)
  │   → sitesProvider / partsProvider (Supabase 실시간)
  │
  └─ 근로자 목록
      → WorkersRepository.getWorkers()
      → Supabase: workers LEFT JOIN worker_profiles
      → site_id/part_id → name 매핑
      → WorkerRow 목록
```

---

## 변경 파일 요약

| 구분 | 파일 | 작업 |
|------|------|------|
| Migration | `supabase/migrations/009_allow_anon_select_sites_parts.sql` | sites/parts 공개 SELECT |
| Provider | `apps/manager_web/lib/core/providers/reference_data_provider.dart` | 신규 — sites/parts 프로바이더 |
| Auth | `apps/manager_web/lib/features/auth/data/auth_repository.dart` | Supabase Auth 전환 |
| Auth | `apps/manager_web/lib/features/auth/providers/auth_provider.dart` | AuthException 처리 |
| Workers | `apps/manager_web/lib/features/workers/data/workers_repository.dart` | Supabase 쿼리 전환 |
| Workers UI | `apps/manager_web/lib/features/workers/presentation/workers_screen.dart` | Supabase 드롭다운 연동 |

---

## 테스트 계정
| 이메일 | 비밀번호 | 역할 | 비고 |
|--------|----------|------|------|
| admin@tkholdings.com | admin1234 | system_admin | Supabase Auth 실 계정 |

## 아직 데모 데이터 유지 중인 것
- DashboardRepository (출퇴근 현황)
- PayrollRepository (급여 계산)
- WorkerDetailRepository (근로자 상세 근태)
- AccountsRepository (계정 관리)
