# v1.17: Supabase 데이터 연결 + 로그인 점검 + UI 체크

## 작업 날짜
2026-02-12

## 작업 요약
모든 데모 데이터를 Supabase 실시간 데이터로 교체하고, Worker App 로그인 흐름을 점검하고, UI를 동적화함.

---

## Phase 1: DB 마이그레이션 + 모델 업데이트

### 변경 사항
- **Supabase Migration**: `worker_profiles` 테이블에 `bank`, `account_number` 컬럼 추가
- **RLS 정책**: `worker_insert_own_profile`, `worker_update_own_profile` 추가 (Worker가 자기 프로필 INSERT/UPDATE 가능)
- **Freezed 모델**: `WorkerProfile`에 `bank`, `accountNumber` 필드 추가 + `build_runner build` 재생성
- **WorkersRepository**: `WorkerRow`에 `bank`, `accountNumber` 필드 추가, `getWorkers()` 매핑 + `saveWorkerProfile()` upsert 반영

### 수정 파일
- `supabase/migrations/011_add_bank_fields_and_worker_rls.sql` (Supabase에 적용됨)
- `packages/core/lib/src/models/worker_profile.dart`
- `apps/manager_web/lib/features/workers/data/workers_repository.dart`

---

## Phase 2: Worker App — Auth Supabase 연결

### 변경 사항
- **WorkerAuthRepository 전면 재작성**: `SupabaseService` 의존성 추가
  - `sendOtp()` → `auth.signInWithOtp(phone:)` (E.164 형식 변환)
  - `verifyOtp()` → `auth.verifyOTP()` → `workers` 테이블에서 Worker 조회
  - `isProfileComplete()` → `worker_profiles` 테이블 조회 (ssn + address 존재 여부)
  - `saveProfile()` → `worker_profiles` upsert
  - `signOut()` → `auth.signOut()`
  - 카카오/구글 → 데모 유지 (SMS OTP만 Supabase 연결)
- **전화번호 E.164 변환 유틸리티**: `toE164()`, `fromE164()` 함수 생성
- **AuthNotifier 흐름 수정**: `verifyOtp()` 후 프로필 완성 여부 체크 → `needsConsent` / `authenticated` 분기

### 수정 파일
- `apps/worker_app/lib/features/auth/data/auth_repository.dart` (전면 재작성)
- `apps/worker_app/lib/core/utils/phone_utils.dart` (신규)
- `apps/worker_app/lib/features/auth/providers/auth_provider.dart`

---

## Phase 3: Worker App — Attendance Supabase 연결

### 변경 사항
- **AttendanceRepository 전면 재작성**: Supabase CRUD
  - `getTodayAttendance()` → SELECT today's record
  - `checkIn()` → INSERT with real GPS coordinates
  - `checkOut()` → UPDATE (work_hours는 DB trigger 자동계산)
  - `getMonthlyAttendances()` → SELECT by date range
- **AttendanceNotifier에 실제 GPS 통합**: `Geolocator.getCurrentPosition()` 사용, GPS 권한 요청 처리
- **AttendanceHistoryScreen**: 인라인 `AttendanceRepository()` → 프로바이더(`attendanceRepositoryProvider`) 통해 주입

### 수정 파일
- `apps/worker_app/lib/features/attendance/data/attendance_repository.dart` (전면 재작성)
- `apps/worker_app/lib/features/attendance/providers/attendance_provider.dart`
- `apps/worker_app/lib/features/attendance/presentation/attendance_history_screen.dart`

---

## Phase 4: Manager Web — Dashboard Supabase 연결

### 변경 사항
- **DashboardRepository 재작성**: Supabase 쿼리 기반
  - `getTodaySummary()`: 활성 근로자 수 + 오늘 출근 현황 쿼리 (주간/야간/지각/조퇴/미출근 집계)
  - `getTodayAttendances()`: workers + attendances + worker_profiles JOIN → 근태 현황 테이블 데이터
  - `getSites()`: 사이트 목록 조회 (동적 센터 드롭다운용)
- **DashboardProvider**: `'demo-site-id'` → auth state에서 실제 siteId 사용
- **DashboardScreen**: 하드코딩 센터명 → `sitesProvider`에서 동적 로드

### 수정 파일
- `apps/manager_web/lib/features/dashboard/data/dashboard_repository.dart` (전면 재작성)
- `apps/manager_web/lib/features/dashboard/providers/dashboard_provider.dart`
- `apps/manager_web/lib/features/dashboard/presentation/dashboard_screen.dart`

---

## Phase 5: Manager Web — WorkerDetail Supabase 연결

### 변경 사항
- **WorkerDetailRepository 재작성**: Supabase 쿼리 기반
  - `getMonthlyAttendance()`: attendances 테이블 date range 쿼리 → 날짜별 매핑 → 출근/지각/조퇴/미출근 판정
  - `getMonthlySummary()`: 출근일수/총근무시간/지각/조퇴/결근 집계
- **Provider + Screen 체인**: `workerName` → `workerId`로 변경
- **onWorkerTap 시그니처 변경**: 전체 앱에서 `void Function(String name)` → `void Function(String id, String name)` 으로 통일
  - DashboardScreen, WorkersScreen, AttendanceRecordsScreen, PayrollScreen, main.dart 모두 수정

### 수정 파일
- `apps/manager_web/lib/features/worker_detail/data/worker_detail_repository.dart` (전면 재작성)
- `apps/manager_web/lib/features/worker_detail/providers/worker_detail_provider.dart`
- `apps/manager_web/lib/features/worker_detail/presentation/worker_detail_screen.dart`
- `apps/manager_web/lib/main.dart` (workerId 전달, _openWorkerDetail 시그니처 변경)
- `apps/manager_web/lib/features/dashboard/presentation/dashboard_screen.dart` (onWorkerTap)
- `apps/manager_web/lib/features/workers/presentation/workers_screen.dart` (onWorkerTap)
- `apps/manager_web/lib/features/attendance_records/presentation/attendance_records_screen.dart` (onWorkerTap)
- `apps/manager_web/lib/features/payroll/presentation/payroll_screen.dart` (onWorkerTap)

---

## Phase 6: Manager Web — Payroll Supabase 연결

### 변경 사항
- **PayrollRepository 재작성**: Supabase 쿼리로 실제 급여 계산
  - workers + attendances JOIN → worker별 출근일수/총근무시간 집계
  - parts 테이블에서 시급 조회 → 기본급/총급여 계산
  - `PayrollRow`에 `workerId` 필드 추가
- **PayrollScreen**: `'demo-site-id'` → auth state 실제 siteId

### 수정 파일
- `apps/manager_web/lib/features/payroll/data/payroll_repository.dart` (전면 재작성)
- `apps/manager_web/lib/features/payroll/presentation/payroll_screen.dart`

---

## Phase 7: Manager Web — Accounts Supabase 연결

### 변경 사항
- **AccountsRepository 재작성**: Supabase 쿼리 기반
  - `getAccounts()`: workers 테이블에서 `role != 'worker'` 조회 + worker_profiles JOIN (email)
  - `saveAccount()`: workers UPDATE + worker_profiles upsert
  - `toggleAccountStatus()`: 현재 상태 조회 후 토글

### 수정 파일
- `apps/manager_web/lib/features/accounts/providers/accounts_provider.dart` (전면 재작성)

---

## Phase 8: 로그인 흐름 점검 + 버그 수정

### 변경 사항
- **PhoneVerificationScreen 버그 수정**: "SMS 인증번호 받기" 버튼 클릭 시 `sendOtp()` 미호출 → 호출 추가

### 수정 파일
- `apps/worker_app/lib/features/auth/presentation/phone_verification_screen.dart`

---

## Phase 9: UI 전체 체크

### 변경 사항
- **Worker App HomeScreen**: '서이천 사업장' 하드코딩 → Supabase에서 실제 사이트명 동적 로드 (`_siteNameProvider`)
- **Geolocator deprecated API 수정**: `desiredAccuracy` → `locationSettings`
- **테스트 파일 수정**: worker_app/test/widget_test.dart 스모크 테스트 플레이스홀더로 교체

### 수정 파일
- `apps/worker_app/lib/features/attendance/presentation/home_screen.dart`
- `apps/worker_app/lib/features/attendance/providers/attendance_provider.dart`
- `apps/worker_app/test/widget_test.dart`

---

## 검증 결과
- `flutter analyze` — Manager Web: 경고 1건 (미사용 함수), 에러 0건
- `flutter analyze` — Worker App: 에러 0건
- `flutter run -d chrome` — Manager Web: 정상 실행 확인

## 주요 아키텍처 변경
1. 모든 Repository가 데모 데이터 대신 `SupabaseService` 통해 실시간 DB 쿼리
2. Worker App Auth: SMS OTP → Supabase Auth 연동, 프로필 완성 여부 체크 추가
3. Worker App Attendance: 실제 GPS 좌표 사용, DB trigger로 work_hours 자동 계산
4. onWorkerTap 시그니처 통일: `(String id, String name)` — workerId 기반 상세 조회
5. 센터 목록 동적화: Supabase sites 테이블에서 조회
