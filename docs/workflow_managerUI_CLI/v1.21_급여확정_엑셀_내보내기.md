# v1.21: 급여 확정 + 엑셀 내보내기 + Worker App 실기기 버그 수정

## 작업일: 2026-02-15

## 변경 요약

### 1. 급여 확정 기능 (Manager Web)
- "확정" 버튼 클릭 → AlertDialog 확인 → Supabase `payrolls` 테이블에 upsert
- `is_finalized=true`, `finalized_at=NOW()` 설정
- `onConflict: worker_id, year_month` — 이미 존재하면 업데이트
- 확정 완료 후 상태 컬럼에 초록색 체크 뱃지 표시
- 전체 확정 시 버튼 비활성화 + "확정 완료" 텍스트 + "모두 확정됨" 툴팁
- 급여대장 생성 시 `checkFinalizationStatus()` 병렬 호출 → 확정 상태 즉시 반영

### 2. 엑셀 내보내기 기능 (Manager Web)
- `excel` 패키지(^4.0.6)로 .xlsx 워크북 생성
- 컬럼: No., 성명, 파트, 출근일수, 총 근무시간, 시급, 기본급, 총 급여
- 헤더 행: 볼드 + 배경색(#E8EAF6)
- 합계 행: 볼드
- `package:web` + `dart:js_interop`로 브라우저 다운로드 트리거
- 파일명: `급여대장_YYYY-MM.xlsx`

### 3. PayrollScreen UI 개선 (Manager Web)
- 테이블에 "상태" 컬럼 추가 (9번째, 80px)
  - 확정: 초록색 체크 아이콘 + "확정" 뱃지
  - 미확정: 회색 "미확정" 텍스트
- 확정 중 로딩 스피너 표시
- 데이터 없을 때 버튼 비활성화

### 4. Manager Web 설정/계정 개선
- 설정 화면: 관리자 계정 탭 제거 → 2탭(일반 설정, 센터/파트 관리)으로 축소
- 계정관리: 사이드 네비 index 5에 독립 메뉴로 분리 (system_admin 전용)
- 계정관리: 직위(position) 컬럼 추가, role 드롭다운 변경

### 5. Worker App 실기기(Galaxy S23+) 버그 수정

#### 5-1. GPS 위치 권한 오류 수정
- **증상**: 출근 버튼 클릭 → "위치 권한 상태를 확인할 수 없습니다"
- **원인**: `AndroidManifest.xml`에 위치 권한 선언 누락 + `Geolocator.checkPermission()` 예외 처리 부족
- **수정**:
  - `AndroidManifest.xml`에 `ACCESS_FINE_LOCATION`, `ACCESS_COARSE_LOCATION`, `INTERNET` 추가
  - `attendance_provider.dart`에서 `checkPermission()` 실패 시 `denied`로 기본값 → `requestPermission()` 재시도
  - 권한 거부 시 `[OPEN_SETTINGS]` 마커 → UI에서 "앱 설정에서 위치 권한 허용하기" 버튼 + `Geolocator.openAppSettings()` 호출

#### 5-2. 근태기록 UUID 오류 수정
- **증상**: 근태기록 탭 진입 → 빨간 에러 `invalid input syntax for type uuid: "demo-worker-id"`
- **원인**: 로컬 캐시에 `"demo-worker-id"` 문자열이 남아있어 Supabase 쿼리 실패
- **수정**: `auth_repository.dart`에 UUID 정규식 검증 추가 → 유효하지 않은 ID 캐시 자동 제거

#### 5-3. 풀스크린 UI 수정
- **증상**: Galaxy S23+에서 화면이 폰 프레임 목업으로 표시 (390x844 고정 크기)
- **원인**: `main.dart`의 `MaterialApp.builder`에서 모든 플랫폼에 폰 프레임 적용
- **수정**: `TargetPlatform.android/iOS`일 때 프레임 건너뛰기 → 네이티브 모바일은 전체 화면 사용

#### 5-4. 데모 로그인 Supabase Auth 연동
- **증상**: 데모 로그인 시 RLS 정책으로 인해 서버 오류
- **원인**: 로컬 Worker 객체만 생성하고 Supabase Auth 세션 없음 → `auth.uid()` 불일치
- **수정**: `signInWithPassword(email, password)` 방식으로 실제 Supabase 인증
  - `auth_repository.dart`에 `demoSignIn()` 메서드 추가
  - Supabase auth.users에 김영수 이메일/비밀번호 설정 (ys.kim@botrens.com / demo1234!)
  - auth.users NULL 컬럼 → 빈 문자열 수정 (Go SQL scanner 호환)
  - `raw_app_meta_data`에 email provider 추가 + auth.identities에 email identity 추가

#### 5-5. UTC → KST 시간 변환
- **증상**: 출근시간 19:45 표시 (실제 04:45 KST)
- **원인**: Supabase UTC 시간을 `.toLocal()` 없이 표시
- **수정**: `home_screen.dart`, `attendance_history_screen.dart`의 모든 시간 포맷에 `.toLocal()` 추가

#### 5-6. 출퇴근 확인 다이얼로그
- 출근/퇴근 버튼 클릭 시 확인 팝업(AlertDialog) 표시
- "출근 처리하시겠습니까?" / "퇴근 처리하시겠습니까?" 확인 후 실행
- 실수로 인한 잘못된 출퇴근 기록 방지

## 신규/수정 파일

### 신규 (1개)
```
apps/manager_web/lib/features/payroll/utils/payroll_excel_export.dart
```

### 수정 — Manager Web (9개)
```
apps/manager_web/pubspec.yaml                                          — excel 패키지 추가
apps/manager_web/lib/core/utils/permissions.dart                       — index 5 = 계정관리 (system_admin)
apps/manager_web/lib/core/widgets/side_nav_drawer.dart                 — 계정관리 메뉴 추가
apps/manager_web/lib/features/accounts/presentation/accounts_screen.dart — 직위 컬럼, role 드롭다운
apps/manager_web/lib/features/accounts/providers/accounts_provider.dart  — position 필드 추가
apps/manager_web/lib/features/payroll/data/payroll_repository.dart     — finalizePayroll, checkFinalizationStatus
apps/manager_web/lib/features/payroll/presentation/payroll_screen.dart — 확정 로직, 엑셀 연결, 상태 컬럼
apps/manager_web/lib/features/settings/presentation/settings_screen.dart — 관리자계정 탭 제거 (2탭)
apps/manager_web/lib/features/settings/providers/settings_provider.dart  — 설정 프로바이더 정리
apps/manager_web/lib/main.dart                                         — AccountsScreen 라우팅 추가
```

### 수정 — Worker App (6개)
```
apps/worker_app/android/app/src/main/AndroidManifest.xml               — 위치 권한 선언 추가
apps/worker_app/lib/features/attendance/presentation/home_screen.dart   — 확인 다이얼로그, 설정 바로가기, 시간 변환
apps/worker_app/lib/features/attendance/presentation/attendance_history_screen.dart — 시간 .toLocal()
apps/worker_app/lib/features/attendance/providers/attendance_provider.dart — GPS 에러 핸들링 강화
apps/worker_app/lib/features/auth/data/auth_repository.dart            — demoSignIn(), UUID 검증
apps/worker_app/lib/features/auth/providers/auth_provider.dart         — demoLogin() 실제 auth 연동
apps/worker_app/lib/main.dart                                          — 네이티브 모바일 프레임 건너뛰기
```

## Supabase DB 변경 (콘솔에서 직접 수행)
- 김영수/김영희 `auth.users`: NULL varchar → 빈 문자열, email identity 추가
- `raw_app_meta_data`: `{"provider":"email","providers":["email","phone"]}` 설정
- 김영수 비밀번호: `demo1234!` (데모 로그인용)
- 서이천센터 `radius`: 50,000m (테스트용, 프로덕션은 100m으로 복원 필요)

## 외부 서비스 설정 가이드

### A. Supabase 카카오/구글 Provider 활성화

#### 카카오 로그인 설정

1. **Kakao Developers 콘솔** (https://developers.kakao.com)
   - 애플리케이션 추가 → 앱 이름: "출퇴근GO"
   - 앱 키 > **REST API 키** 복사
   - 제품 설정 > 카카오 로그인 > 활성화 설정: ON
   - 동의항목: 닉네임, 프로필 사진, 이메일 (선택)
   - Redirect URI 추가: `https://<project-ref>.supabase.co/auth/v1/callback`

2. **Supabase Dashboard** (https://supabase.com/dashboard)
   - Authentication > Providers > **Kakao**
   - Enabled: ON
   - Client ID: REST API 키 붙여넣기
   - Client Secret: Kakao 앱 > 보안 > Client Secret 코드 발급 후 붙여넣기

#### 구글 로그인 설정

1. **Google Cloud Console** (https://console.cloud.google.com)
   - API 및 서비스 > 사용자 인증 정보 > OAuth 2.0 클라이언트 ID 만들기
   - 애플리케이션 유형: 웹 애플리케이션
   - 승인된 리디렉션 URI: `https://<project-ref>.supabase.co/auth/v1/callback`
   - 클라이언트 ID / 클라이언트 보안 비밀번호 복사

2. **Supabase Dashboard**
   - Authentication > Providers > **Google**
   - Enabled: ON
   - Client ID / Client Secret 붙여넣기

#### 공통 설정

- Supabase Dashboard > Authentication > URL Configuration > Redirect URLs:
  - `io.supabase.workflowapp://login-callback` 추가 (모바일 딥링크)

---

### B. juso.go.kr API 키 발급 + .env 설정

1. **도로명주소 API 신청** (https://business.juso.go.kr/addrlink/openApi/apiReqst.do)
   - 회원가입 후 로그인
   - "도로명주소 API 신청" 클릭
   - 서비스 명: "출퇴근GO", 활용 용도: "사내 근로자 관리"
   - 검색 API (도로명주소 검색) 체크
   - 승인 후 **승인키(confmKey)** 복사

2. **.env 파일 설정** (`apps/worker_app/.env`)
   ```
   SUPABASE_URL=https://<project-ref>.supabase.co
   SUPABASE_ANON_KEY=<your-anon-key>
   JUSO_CONFIRM_KEY=<juso.go.kr에서 발급받은 승인키>
   ```

3. **확인**: Worker App > 프로필 완성 > 주소 검색 시 실제 도로명주소 결과 표시

---

### C. Worker App 실기기 빌드 + GPS 출퇴근 실테스트

#### Android APK 빌드

```bash
# 서명 키 생성 (최초 1회)
keytool -genkey -v -keystore ~/upload-keystore.jks \
  -keyalg RSA -keysize 2048 -validity 10000 \
  -alias upload

# key.properties 파일 생성
# apps/worker_app/android/key.properties
storePassword=<password>
keyPassword=<password>
keyAlias=upload
storeFile=<path>/upload-keystore.jks

# APK 빌드
cd apps/worker_app
flutter build apk --release

# 출력 경로: build/app/outputs/flutter-apk/app-release.apk
```

#### iOS IPA 빌드

```bash
# Xcode에서 Team 설정 필요
cd apps/worker_app
flutter build ipa --release

# 출력 경로: build/ios/ipa/
# Xcode > Window > Organizer에서 Archive 업로드 가능
```

#### GPS 출퇴근 실테스트 체크리스트

- [x] 앱 설치 후 위치 권한 팝업 → "앱 사용 중 허용" 선택
- [x] GPS 정상 수신 (15초 내 위치 확인)
- [x] 출근 버튼 → 확인 다이얼로그 → 출근 기록 성공
- [x] 퇴근 버튼 → 확인 다이얼로그 → 퇴근 기록 + work_hours 자동 계산
- [x] 출퇴근 시간 KST 정상 표시
- [x] 근태기록 탭 정상 로드 (UUID 오류 해결)
- [x] 풀스크린 UI 정상 (폰 프레임 목업 제거)
- [ ] 센터 반경 밖에서 출근 → "근무지 반경 밖입니다" 에러
- [ ] GPS 정확도 500m 초과 시 → "GPS 정확도가 낮습니다" 경고
- [ ] GPS 타임아웃(15초) → "GPS 신호를 받지 못했습니다" 메시지
- [ ] 배터리 절약 모드에서 GPS 동작 확인

## 검증
- `flutter pub get` → 의존성 설치 성공
- `flutter run -d chrome` → 급여관리 화면 정상 로드
- 급여대장 생성 → 테이블 + 상태 컬럼 표시
- 엑셀 내보내기 → .xlsx 파일 브라우저 다운로드
- 확정 → AlertDialog → 상태 컬럼 초록 뱃지 전환
- Worker App APK 설치 → 데모 로그인 → GPS 출퇴근 테스트 성공 (Galaxy S23+)
