# v1.22: 대시보드 차트 + 근태 수정/삭제 + Worker App 개선

## 작업 일자
2026-02-16

## 변경 사항 요약

### Feature 1: 대시보드 차트 추가
- **fl_chart ^0.70.2** 의존성 추가
- `DailyAttendanceStat` 클래스 + `getWeeklyTrend()` 메서드 (일별 출근율 집계)
- `weeklyTrendProvider` — 7일간 출근율 데이터 FutureProvider
- `AttendanceTrendChart` — fl_chart LineChart (7일 출근율 추이, X=날짜, Y=0~100%)
- `StatusDistributionChart` — fl_chart PieChart (오늘 정상출근/지각/조퇴/미출근 비율)
- DashboardScreen에 차트 Row 삽입 (라인차트 60% + 파이차트 40%)

### Feature 2: 근태 기록 수정/삭제
- **Supabase RLS 마이그레이션** (`011_attendance_manager_update_delete.sql`)
  - center_manager: 같은 사업장 UPDATE/DELETE
  - owner/system_admin: 전체 UPDATE/DELETE
- `canEditAttendance(AppRole)` 권한 헬퍼 추가
- `AttendanceRecordsRepository` — 날짜 범위 조회, 수정, 삭제
- `attendanceDateRangeProvider` (기본: 오늘) + `attendanceRecordsProvider`
- `AttendanceEditDialog` — TimePicker, 상태 드롭다운, 비고 입력
- `AttendanceDeleteDialog` — 삭제 확인
- `AttendanceRecordsScreen` 전면 수정:
  - 전용 provider 사용 (기존 todayAttendancesProvider 대신)
  - 날짜 범위 필터 실제 동작
  - "관리" 컬럼 추가 (수정/삭제 아이콘, 권한 체크)
  - 날짜 컬럼 실제 데이터 표시 (하드코딩 버그 수정)
- main.dart: `AttendanceRecordsScreen`에 `role` 전달

### Feature 3a: 조퇴 사유 저장
- `earlyLeaveCheckOut()` — status='leave', notes=reason 으로 Supabase 업데이트
- `earlyLeave(String reason)` 메서드 추가 (attendanceProvider)
- 홈 화면 조퇴 다이얼로그:
  - TODO 제거 → `earlyLeave(reason)` 호출
  - 사유 미입력 시 버튼 비활성화 (StatefulBuilder 활용)

### Feature 3b: 공지사항 시스템
- **Supabase 마이그레이션** (`012_create_announcements.sql`)
  - announcements 테이블 (title, content, site_id, created_by, is_active)
  - site_id NULL = 전체 공지
  - RLS: 인증 사용자 SELECT, 관리자 CUD
- **Freezed 모델**: `packages/core/lib/src/models/announcement.dart`
- **Manager Web 공지 관리**:
  - `AnnouncementRepository` — CRUD
  - `announcementsProvider` — 목록 조회
  - `AnnouncementFormDialog` — 제목/내용/대상사업장
  - SettingsScreen 3번째 탭: 공지사항 목록 + 생성/수정/삭제/활성화 토글
- **Worker App 공지 표시**:
  - `WorkerAnnouncementRepository` — 활성 공지 조회 (전체 + 내 사업장)
  - `workerAnnouncementsProvider`
  - HomeScreen: 공지사항 섹션 (접이식 카드, 최대 3건)

## 신규/수정 파일

### Manager Web
| 파일 | 상태 |
|------|------|
| `pubspec.yaml` | 수정 (fl_chart 추가) |
| `features/dashboard/data/dashboard_repository.dart` | 수정 (DailyAttendanceStat, getWeeklyTrend) |
| `features/dashboard/providers/dashboard_provider.dart` | 수정 (weeklyTrendProvider) |
| `features/dashboard/presentation/dashboard_screen.dart` | 수정 (차트 삽입) |
| `features/dashboard/presentation/widgets/dashboard_charts.dart` | **신규** |
| `features/attendance_records/data/attendance_records_repository.dart` | **신규** |
| `features/attendance_records/providers/attendance_records_provider.dart` | **신규** |
| `features/attendance_records/presentation/attendance_records_screen.dart` | 수정 (전면 재작성) |
| `features/attendance_records/presentation/widgets/attendance_edit_dialog.dart` | **신규** |
| `features/attendance_records/presentation/widgets/attendance_delete_dialog.dart` | **신규** |
| `features/settings/data/announcement_repository.dart` | **신규** |
| `features/settings/providers/announcement_provider.dart` | **신규** |
| `features/settings/presentation/settings_screen.dart` | 수정 (3탭: 공지사항) |
| `features/settings/presentation/widgets/announcement_form_dialog.dart` | **신규** |
| `core/utils/permissions.dart` | 수정 (canEditAttendance) |
| `main.dart` | 수정 (role 전달) |

### Worker App
| 파일 | 상태 |
|------|------|
| `features/attendance/data/attendance_repository.dart` | 수정 (earlyLeaveCheckOut) |
| `features/attendance/providers/attendance_provider.dart` | 수정 (earlyLeave) |
| `features/attendance/presentation/home_screen.dart` | 수정 (조퇴 사유 + 공지사항) |
| `features/announcements/data/announcement_repository.dart` | **신규** |
| `features/announcements/providers/announcement_provider.dart` | **신규** |

### Shared / Supabase
| 파일 | 상태 |
|------|------|
| `packages/core/lib/src/models/announcement.dart` | **신규** (Freezed) |
| `packages/core/lib/core.dart` | 수정 (export 추가) |
| `supabase/migrations/011_attendance_manager_update_delete.sql` | **신규** |
| `supabase/migrations/012_create_announcements.sql` | **신규** |

## Supabase 적용 필요
```sql
-- 011: 근태 수정/삭제 RLS 정책 (center_manager/admin)
-- 012: 공지사항 테이블 + RLS
```
Supabase Dashboard > SQL Editor에서 011, 012 마이그레이션 실행 필요
