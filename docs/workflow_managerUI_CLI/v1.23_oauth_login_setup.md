# v1.23: 카카오/구글 OAuth 실제 로그인 설정 + 보안 강화

## 작업 일자
2026-02-17

## 변경 사항 요약

### Feature 1: 카카오 OAuth 실제 로그인 성공
- **카카오 개발자 콘솔 설정 완료**
  - 앱 "WorkFlow" (ID 1387507) 생성
  - 개인 개발자 비즈 앱 전환 (account_email 동의항목 활성화)
  - 동의항목: 닉네임(필수), 프로필사진(필수), 이메일(필수/수집)
  - 웹 도메인: `http://localhost` 등록
  - Redirect URI: `https://panigexuqlafvdzydbtg.supabase.co/auth/v1/callback`
  - 앱 아이콘 등록 (커스텀 WorkFlow 아이콘)
- **Supabase Kakao Provider 설정**
  - REST API Key + Client Secret 입력
  - "Allow users without email" 활성화
- **웹/모바일 분기 리다이렉트** 구현
  - 웹: `Uri.base.origin` (localhost 등)
  - 모바일: `io.supabase.workflowapp://login-callback`
- **카카오 로그인 → 전화번호 매칭 → 프로필 입력 → 홈 화면까지 전체 플로우 정상 동작 확인**

### Feature 2: 구글 OAuth 설정
- **Google Cloud Console 설정 완료**
  - 프로젝트: My First Project
  - OAuth 동의 화면: 외부, 앱명 "출퇴근GO"
  - OAuth 클라이언트 ID: 웹 애플리케이션 "WorkFlow"
  - 승인된 리디렉션 URI: `https://panigexuqlafvdzydbtg.supabase.co/auth/v1/callback`
- **Supabase Google Provider 설정**
  - Client ID + Client Secret 입력
  - "Enable Sign in with Google" 활성화
  - "Skip nonce checks" 활성화 (모바일 iOS 호환)
- (테스트 예정)

### Feature 3: RLS 정책 수정 + 버그 수정
- **Supabase RLS 정책 추가**
  - `authenticated_select_workers`: 인증된 사용자가 workers 테이블 조회 가능 (OAuth 전화번호 매칭용)
  - `authenticated_insert_worker_profiles`: 인증된 사용자가 프로필 INSERT 가능
  - `authenticated_update_worker_profiles`: 인증된 사용자가 프로필 UPDATE 가능
  - `authenticated_select_worker_profiles`: 인증된 사용자가 프로필 SELECT 가능
  - (원인: OAuth 로그인 시 새 Auth UUID가 workers.id와 불일치하여 기존 RLS 차단)
- **전화번호 형식 호환 수정** (`matchWorkerByPhone`)
  - DB에 `010-1234-5678`(대시 포함)과 `01012345678`(대시 없음) 혼재
  - `.or()` 필터로 두 형식 모두 검색하도록 개선
- **마이페이지 UUID 표시 버그 수정**
  - 보라색 헤더 카드에 worker UUID가 그대로 표시되던 문제
  - `worker.id` → `_roleLabel(worker.role)` 한글 역할명으로 변경
  - system_admin→시스템 관리자, owner→대표, center_manager→센터 관리자, worker→근로자

### Feature 4: 보안 강화
- **.gitignore 강화**
  - `**/.env`, `apps/**/.env` (앱별 .env 보호)
  - `**/build/` (빌드 출력물 전체, .env 복사본 포함)
  - `*.jks`, `*.keystore`, `key.properties` (Android 서명 키)
  - `google-services.json`, `GoogleService-Info.plist` (Firebase 설정)
- **보안 점검 결과**: Dart 코드에 API 키 하드코딩 없음 확인

### Feature 5: 외부 서비스 설정
- **Supabase 마이그레이션 적용**
  - 011: 근태 수정/삭제 RLS 정책 (center_manager, admin)
  - 012: 공지사항 테이블 + RLS + updated_at 트리거
  - 보안 경고 수정 (function search_path)
- **Supabase Redirect URLs**
  - `io.supabase.workflowapp://login-callback` (모바일)
  - `http://localhost` (웹 테스트)
- **juso.go.kr 주소 검색 API**
  - 도로명주소 검색 API 키 발급
  - `apps/worker_app/.env`에 `JUSO_CONFIRM_KEY` 등록
  - `.env.example`에 플레이스홀더 추가

## 신규/수정 파일

| 파일 | 상태 |
|------|------|
| `apps/worker_app/lib/features/auth/data/auth_repository.dart` | 수정 (웹/모바일 분기 리다이렉트, 전화번호 형식 호환) |
| `apps/worker_app/lib/features/profile/presentation/my_page_screen.dart` | 수정 (UUID→역할명 표시) |
| `.gitignore` | 수정 (보안 강화) |
| `.env.example` | 수정 (JUSO_CONFIRM_KEY 추가) |
| `apps/worker_app/.env` | 수정 (JUSO_CONFIRM_KEY 추가) |
| `docs/app_icon_generator.html` | 신규 (앱 아이콘 생성기) |
| `docs/kakao_developer_policy.md` | 신규 (카카오 정책 요약) |

## 카카오 개발자 설정 요약

| 항목 | 값 |
|------|------|
| 앱 ID | 1387507 |
| 앱 이름 | WorkFlow |
| 비즈 앱 | 개인 개발자 비즈 앱 |
| REST API Key | 58675435813d990265ef8a8b71aca70c |
| 웹 도메인 | http://localhost |
| Redirect URI | https://panigexuqlafvdzydbtg.supabase.co/auth/v1/callback |
| 동의항목 | 닉네임(필수), 프로필사진(필수), 이메일(필수/수집) |

## 구글 개발자 설정 요약

| 항목 | 값 |
|------|------|
| 프로젝트 | My First Project |
| OAuth 클라이언트 | WorkFlow (웹 애플리케이션) |
| 리디렉션 URI | https://panigexuqlafvdzydbtg.supabase.co/auth/v1/callback |

## 다음 작업 (v1.24 예정)
1. 구글 로그인 실제 테스트
2. SMS 로그인 (Twilio 연동 필요, 유료)
3. Worker App 실기기 빌드 (APK/IPA) + 모바일 OAuth 테스트
