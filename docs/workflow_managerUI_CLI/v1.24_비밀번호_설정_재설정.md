# v1.24: 비밀번호 자체 설정/재설정 기능

## 작업 일시
2026-02-17

## 변경 요약
계정 생성 시 Supabase Auth 유저를 함께 생성하고, 비밀번호 재설정 플로우를 구현

## 변경 파일

### 신규 파일
| 파일 | 설명 |
|------|------|
| Edge Function `create-auth-user` | service_role로 Auth유저+workers+worker_profiles 생성 |
| `features/auth/presentation/password_reset_dialog.dart` | 비밀번호 재설정 요청 + 새 비밀번호 설정 다이얼로그 |

### 수정 파일
| 파일 | 변경 내용 |
|------|-----------|
| `packages/supabase_client/.../supabase_service.dart` | `functions` getter 추가 |
| `features/accounts/providers/accounts_provider.dart` | `createAccount()` 메서드 추가 (Edge Function 호출) |
| `features/accounts/presentation/accounts_screen.dart` | 신규 등록 시 이메일(필수)/비밀번호(필수) 필드, 저장 분기(create vs update) |
| `features/auth/data/auth_repository.dart` | `resetPasswordForEmail()`, `updatePassword()` 추가 |
| `features/auth/providers/auth_provider.dart` | `isPasswordRecovery` 상태, recovery 이벤트 리스너, resetPassword/updatePassword/clearRecovery |
| `features/auth/presentation/login_screen.dart` | "비밀번호를 잊으셨나요?" 링크 추가 |
| `main.dart` | recovery 상태 감지 → PasswordChangeDialog 자동 표시 |

## 기능 상세

### 1. 계정 생성 (Edge Function)
- `create-auth-user` Edge Function: service_role key로 Auth 유저 생성
- email, password, name, phone, role 필수 / site_id, part_id, position 선택
- 롤백 처리: worker/profile 실패 시 Auth 유저 삭제
- CORS 헤더 포함

### 2. 계정관리 화면 (신규 등록)
- 신규 등록 시 이메일(필수), 초기 비밀번호(필수, 6자 이상) 필드 표시
- "계정 생성" 버튼 → Edge Function 호출
- 수정 시 기존 saveAccount() 유지

### 3. 비밀번호 재설정
- 로그인 화면: "비밀번호를 잊으셨나요?" → 이메일 입력 다이얼로그
- `resetPasswordForEmail()` → 재설정 링크 이메일 발송
- 이메일 링크 클릭 → `passwordRecovery` 이벤트 감지
- PasswordChangeDialog 자동 표시 → 새 비밀번호 입력 → `updateUser(password:)` 호출

## 검증
- [x] Flutter build 성공 (Chrome)
- [ ] 계정관리 → 신규 등록 (이메일+임시비밀번호) → 성공 확인
- [ ] 생성된 계정으로 로그인 성공 확인
- [ ] 비밀번호 재설정 이메일 발송 확인
- [ ] 이메일 링크 → 새 비밀번호 설정 → 로그인 확인
