# v1.26: 코드 리뷰 Critical/High 이슈 수정

## 작업 일자
2026-02-19

## 변경 사항 요약

### Critical 이슈 수정 (6건)

#### 1. 센터장 근로자 필터 하드코딩 제거
- **파일:** `workers_screen.dart:548`
- **문제:** `w.site == '서이천'` 하드코딩 → 서이천 센터장만 동작
- **수정:** `userSiteId` 파라미터 추가 → `siteNameByIdProvider`로 동적 사이트명 조회 후 필터링
- WorkersScreen에 `userSiteId` 파라미터 추가, main.dart에서 전달

#### 2. GPS 정확도 임계값 강화
- **파일:** `attendance_provider.dart:118`
- **문제:** GPS 정확도 500m까지 허용 → 부정확한 위치로 출퇴근 가능
- **수정:** 임계값 500m → 100m로 변경

#### 3. 중복 출근 race condition 방어
- **파일:** `attendance_provider.dart:135-167`
- **문제:** 동시 출근 요청 시 DB 중복 삽입 가능
- **수정:**
  - DB unique constraint 위반(23505) catch → 기존 기록 복원
  - Supabase 마이그레이션 013: `idx_attendances_worker_daily` 유니크 인덱스 추가
  - `to_kst_date()` IMMUTABLE 함수로 KST 기준 날짜 변환

#### 4. Migration 012 트리거 함수명 불일치
- **파일:** `012_create_announcements.sql:56`
- **문제:** `update_updated_at_column()` 참조 → 실제 함수명은 `update_updated_at()`
- **수정:** 함수명 일치시키고, 마이그레이션 013에서 트리거 재생성

#### 5. work_hours 음수 방지
- **파일:** `003_create_triggers.sql`, 마이그레이션 013
- **문제:** check_out < check_in 시 음수 work_hours 가능
- **수정:** `GREATEST(0, ...)` 래핑 + SECURITY DEFINER + search_path 설정

#### 6. calendar_events RLS 강화
- **마이그레이션:** 014
- **문제:** INSERT/UPDATE/DELETE 정책이 `USING (true)` → 모든 인증 사용자 가능
- **수정:** `get_my_role() IN ('center_manager', 'owner', 'system_admin')` 조건 추가

### High 이슈 수정 (10건)

#### 7. 신규 근로자 ID: timestamp → UUID
- **파일:** `workers_screen.dart:129`
- **문제:** `DateTime.now().millisecondsSinceEpoch.toString()` → 유효한 UUID 아님
- **수정:** `uuid` 패키지 추가, `const Uuid().v4()` 사용

#### 8. workers_repository 에러 삼킴 수정
- **파일:** `workers_repository.dart:173-176`
- **문제:** 모든 에러를 catch → 빈 목록 반환 (실제 에러 감춤)
- **수정:** UUID 형식 에러만 빈 목록 반환, 그 외 rethrow

#### 9. workers_screen 저장 try-catch 추가
- **파일:** `workers_screen.dart:151`
- **문제:** `saveWorkerProfile()` 에러 시 무반응
- **수정:** try-catch 추가, 실패 시 빨간 SnackBar 에러 메시지

#### 10. 근태 기록 삭제: hard delete → soft delete
- **파일:** `attendance_records_repository.dart:120-122`
- **문제:** `.delete()` → 데이터 영구 삭제, 복구 불가
- **수정:** `status='deleted'` + 삭제 메모 update, 조회 시 `neq('status', 'deleted')` 필터

#### 11. Worker App OAuth state loop 방어
- **파일:** `auth_provider.dart:56-64`
- **문제:** `restoreSession()` ↔ `onAuthStateChange` 무한 루프 가능
- **수정:** `_isRestoring` 플래그로 재진입 방지, finally 블록에서 해제

#### 12. 프로필 입력 SSN 유효성 검증 강화
- **파일:** `profile_completion_screen.dart`
- **문제:** 길이만 검사 (6+7자리), 뒷자리 첫 숫자 무검증
- **수정:** 뒷자리 첫 숫자 1~4 범위 검증 추가

#### 13. SMS 인증 TextEditingController 메모리 누수
- **파일:** `login_screen.dart:117-118`
- **문제:** bottom sheet 내 controller 생성 후 dispose 미호출
- **수정:** `showModalBottomSheet().whenComplete()` 에서 dispose 호출

#### 14. auth_repository 세션 복원 로직 개선
- **파일:** `auth_repository.dart`
- **문제:** DB에서 worker 못 찾으면 바로 로컬 캐시로 폴백 → 불일치 가능
- **수정:** DB 조회 실패 → 로컬 캐시 확인 → null 반환 순서 명확화

#### 15. 프로필 입력 하드코딩 센터 목록 → 동적 로드
- **파일:** `profile_completion_screen.dart`, `profile_provider.dart`
- **문제:** `_sites = ['서이천', '안성', '의왕', '부평']` 하드코딩
- **수정:** `workerSiteNamesProvider` 추가 (Supabase sites 테이블 조회), 은행 목록도 확장 (20개)

#### 16. 주소 API 키 미설정 시 피드백
- **파일:** `profile_completion_screen.dart`
- **문제:** API 키 없으면 검색 실행 후 결과 없음만 표시
- **수정:** API 키 미설정 시 즉시 SnackBar 경고 + 검색 차단

### Supabase 마이그레이션

| 마이그레이션 | 내용 |
|---|---|
| 013_fix_triggers_and_constraints | work_hours 음수 방지, 공지 트리거 수정, 중복 출근 방지 인덱스 |
| 014_fix_security_warnings | to_kst_date search_path, calendar_events RLS 강화 |

### 미처리 항목 (Dashboard에서 수동 설정 필요)

| 항목 | 위치 |
|---|---|
| Leaked Password Protection 활성화 | Supabase Dashboard > Authentication > Settings > Password Security |

## 신규/수정 파일

| 파일 | 상태 |
|------|------|
| `apps/manager_web/lib/features/workers/presentation/workers_screen.dart` | 수정 (userSiteId, UUID, try-catch) |
| `apps/manager_web/lib/features/workers/data/workers_repository.dart` | 수정 (에러 핸들링) |
| `apps/manager_web/lib/features/attendance_records/data/attendance_records_repository.dart` | 수정 (soft delete, deleted 필터) |
| `apps/manager_web/lib/main.dart` | 수정 (WorkersScreen에 userSiteId 전달) |
| `apps/manager_web/pubspec.yaml` | 수정 (uuid 패키지 추가) |
| `apps/worker_app/lib/features/attendance/providers/attendance_provider.dart` | 수정 (GPS 100m, race condition) |
| `apps/worker_app/lib/features/auth/providers/auth_provider.dart` | 수정 (state loop 방어) |
| `apps/worker_app/lib/features/auth/data/auth_repository.dart` | 수정 (세션 복원 개선) |
| `apps/worker_app/lib/features/auth/presentation/login_screen.dart` | 수정 (controller dispose) |
| `apps/worker_app/lib/features/auth/presentation/profile_completion_screen.dart` | 수정 (SSN 검증, 동적 센터, API 키 피드백) |
| `apps/worker_app/lib/features/profile/providers/profile_provider.dart` | 수정 (workerSiteNamesProvider 추가) |
| `supabase/migrations/003_create_triggers.sql` | 수정 (GREATEST, NULL 체크) |
| `supabase/migrations/012_create_announcements.sql` | 수정 (함수명 수정) |
| `supabase/migrations/013_fix_triggers_and_constraints.sql` | 신규 |
| `supabase/migrations/014_fix_security_warnings.sql` | 신규 |

## 다음 작업 (v1.27 예정)
1. Supabase Dashboard에서 Leaked Password Protection 활성화
2. 전화번호 형식 통일 마이그레이션 (DB 내 010-XXXX-XXXX → 01012345678)
3. Payroll 확정 서버사이드 인증 (Edge Function)
