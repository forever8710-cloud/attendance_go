# v1.29 - 신규 계정 가입정보 이메일 전송 기능

**작업일:** 2026-02-22

---

## 변경 사항

### 1. DB 마이그레이션
- `worker_profiles` 테이블에 `personal_email` (TEXT) 컬럼 추가
- Supabase Migration: `add_personal_email_to_worker_profiles`

### 2. Edge Function: `send-welcome-email` 배포
- **Resend API** 사용 (무료 100건/일)
- 발신: `WorkFlow <onboarding@resend.dev>`
- 파라미터: `to_email`, `name`, `login_email`, `password`(선택), `web_url`(선택)
- HTML 이메일 템플릿: 인디고 그라디언트 헤더, 가입정보 테이블, 보안 경고, CTA 버튼
- 비밀번호 포함/미포함 자동 분기 (신규 생성 시 포함, 기존 계정 전송 시 미포함)
- Supabase Secrets에 `RESEND_API_KEY` 등록 완료

### 3. AccountRow 모델 확장
- `personalEmail` 필드 추가
- `getAccounts()`: `worker_profiles(email, position, personal_email)` select
- `saveAccount()`: `personal_email` upsert 포함
- `createAccount()`: `personalEmail` 파라미터 추가
- `sendWelcomeEmail()`: Edge Function 호출 메서드 추가

### 4. 계정관리 UI 변경
- **신규 등록 폼**: 초기 비밀번호 옆에 `개인 이메일 (가입정보 수신용)` 필드 추가
- **기존 계정 폼**: 별도 행에 `개인 이메일` 필드 추가
- **계정 목록 테이블**: `개인 이메일` 컬럼 추가
- **"가입정보 메일 전송" 버튼**: 기존 계정 선택 + 개인 이메일 입력 시 활성화 (비밀번호 미포함)
- **생성 후 자동 전송 다이얼로그**: 신규 계정 생성 + 개인 이메일 입력 시 자동 표시
  - "전송" → 비밀번호 포함 이메일 발송
  - "건너뛰기" → 전송 없이 닫기

---

## 수정 파일

| 파일 | 변경 |
|------|------|
| `supabase/migrations/015_add_personal_email.sql` | `worker_profiles`에 `personal_email` 컬럼 추가 |
| `supabase/functions/send-welcome-email/index.ts` | 신규 Edge Function (Resend API) |
| `accounts_provider.dart` | `personalEmail` 필드, `sendWelcomeEmail()` 메서드 |
| `accounts_screen.dart` | 개인 이메일 필드, 메일 전송 버튼, 생성 후 전송 다이얼로그 |

---

## 이메일 템플릿 구성

```
[WorkFlow 헤더 - 인디고 그라디언트]
{이름}님, 안녕하세요!
WorkFlow 관리자 계정이 생성되었습니다.

| 로그인 아이디 | example@email.com |
| 초기 비밀번호 | ******* |  (신규 생성 시만)
| 접속 주소     | myprojectjihun.web.app |

⚠️ 보안을 위해 최초 로그인 후 반드시 비밀번호를 변경해 주세요.

[로그인 하러 가기 버튼]
```

---

## 사전 준비 완료 항목
- [x] Resend API Key 발급
- [x] Supabase Secrets에 `RESEND_API_KEY` 등록
- [x] Edge Function 배포 (`send-welcome-email`)
- [x] DB Migration 적용 (`personal_email` 컬럼)
- [x] Firebase 빌드 + 배포

## 참고
- Resend 무료 플랜: 일 100건, 발신 도메인 `onboarding@resend.dev`
- 커스텀 도메인 발신은 Resend에서 도메인 등록 후 가능
