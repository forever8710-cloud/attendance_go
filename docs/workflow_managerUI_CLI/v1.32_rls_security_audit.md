# v1.32 — RLS 보안 점검 및 수정

**작업일:** 2026-02-23
**범위:** Supabase DB 전체 9개 테이블 Row Level Security 정책 점검

---

## 점검 결과 요약

| 테이블 | 정책 수 | 상태 | 수정 |
|--------|---------|------|------|
| `workers` | 5 | CRITICAL 발견 → 수정 | `authenticated_select_workers` 제거 |
| `worker_profiles` | 7 | CRITICAL 발견 → 수정 | `authenticated_*` 3개 제거 |
| `sites` | 4 | HIGH 발견 → 수정 | admin INSERT/UPDATE/DELETE 추가 |
| `parts` | 4 | HIGH 발견 → 수정 | admin INSERT/UPDATE/DELETE 추가 |
| `payrolls` | 6 | MEDIUM 발견 → 수정 | admin DELETE 추가 |
| `attendances` | 9 | 양호 | 변경 없음 |
| `announcements` | 4 | 양호 | 변경 없음 |
| `calendar_events` | 4 | 양호 | 변경 없음 |
| `consent_logs` | 3 | 양호 | 변경 없음 |

---

## CRITICAL 수정 (2건)

### C#1. worker_profiles — 개인정보 무단 접근 차단

**발견:** `authenticated_select_worker_profiles`, `authenticated_insert_worker_profiles`, `authenticated_update_worker_profiles` 3개 정책으로 인해 **인증된 사용자 누구나** 모든 worker_profiles 데이터(주민번호, 주소, 은행계좌) 접근 가능.

**위험도:** 개인정보보호법 위반 소지. APK 디컴파일 후 Supabase URL+anon_key로 직접 API 호출 시 전 직원 개인정보 유출 가능.

**수정:**
```sql
DROP POLICY "authenticated_select_worker_profiles" ON worker_profiles;
DROP POLICY "authenticated_insert_worker_profiles" ON worker_profiles;
DROP POLICY "authenticated_update_worker_profiles" ON worker_profiles;
```

**수정 후 정책:**
- `worker_select_own_profile` — 본인 프로필만 조회
- `worker_insert_own_profile` — 본인 프로필만 생성
- `worker_update_own_profile` — 본인 프로필만 수정
- `admin_select_all_profiles` — 관리자(center_manager+) 전체 조회
- `admin_insert_profiles` — 관리자(center_manager+) 생성
- `admin_update_profiles` — 관리자(center_manager+) 수정
- `admin_delete_profiles` — 관리자(center_manager+) 삭제

### C#2. workers — 근로자 정보 무단 조회 차단

**발견:** `authenticated_select_workers` 정책으로 인해 **인증된 사용자 누구나** 모든 workers 레코드(전화번호, 역할, 사이트 배정) 조회 가능.

**수정:**
```sql
DROP POLICY "authenticated_select_workers" ON workers;
```

**수정 후 정책:**
- `worker_select_own` — 본인 레코드만 (`auth.uid() = id`)
- `center_manager_select_site` — 센터장은 본인 사이트만
- `admin_select_all` — owner/system_admin 전체

---

## HIGH 수정 (2건)

### H#1. sites — 관리자 쓰기 정책 추가

**발견:** SELECT 정책만 존재. RLS 활성화 상태에서 INSERT/UPDATE/DELETE 정책 미존재 → 관리자도 사이트 정보 수정 불가.

**수정:**
```sql
CREATE POLICY "admin_insert_sites" ON sites FOR INSERT WITH CHECK (get_my_role() IN ('owner', 'system_admin'));
CREATE POLICY "admin_update_sites" ON sites FOR UPDATE USING (get_my_role() IN ('owner', 'system_admin'));
CREATE POLICY "admin_delete_sites" ON sites FOR DELETE USING (get_my_role() IN ('owner', 'system_admin'));
```

### H#2. parts — 관리자 쓰기 정책 추가

**수정:** sites와 동일 패턴 적용.

---

## MEDIUM 수정 (1건)

### M#1. payrolls — DELETE 정책 추가

**수정:**
```sql
CREATE POLICY "admin_delete_payroll" ON payrolls FOR DELETE USING (get_my_role() IN ('owner', 'system_admin'));
```

---

## 수정 후 최종 정책 매트릭스

| 테이블 | SELECT | INSERT | UPDATE | DELETE |
|--------|--------|--------|--------|--------|
| **workers** | 본인/센터장(사이트)/관리자(전체) | 관리자+ | 관리자+ | 관리자+ |
| **worker_profiles** | 본인/관리자+ | 본인/관리자+ | 본인/관리자+ | 관리자+ |
| **attendances** | 본인/센터장(사이트)/관리자(전체) | 본인 | 본인/센터장/관리자 | 센터장/관리자 |
| **payrolls** | 본인/센터장(사이트)/관리자(전체) | 관리자+ | 관리자+ | owner/system_admin |
| **sites** | 전체(공개) | owner/system_admin | owner/system_admin | owner/system_admin |
| **parts** | 전체(공개) | owner/system_admin | owner/system_admin | owner/system_admin |
| **announcements** | 인증+활성 | 관리자+ | 관리자+ | 관리자+ |
| **calendar_events** | 인증 전체 | 관리자+ | 관리자+ | 관리자+ |
| **consent_logs** | 본인/관리자 | 본인 | — | — |

---

## 추가 보안 권고 (Supabase 설정)

### 1. Leaked Password Protection 활성화
Supabase 보안 어드바이저 경고: HaveIBeenPwned 유출 비밀번호 차단 미활성화.
- **설정 경로:** Supabase Dashboard > Authentication > Security > Password Protection
- **권장:** "Enable" 설정

---

## 앱 영향도 분석

### Manager Web — 영향 없음
- 로그인 사용자: system_admin/owner/center_manager
- `admin_select_all` 또는 `center_manager_select_site` 정책으로 정상 접근
- sites/parts SELECT: `*_select_public` 정책으로 정상 접근

### Worker App — 영향 없음
- 본인 데이터만 접근: `worker_select_own`, `worker_own_attendance`, `worker_select_own_profile`
- 사이트 조회: `sites_select_public` 정책으로 정상 접근
- 파트 조회: `parts_select_public` 정책으로 정상 접근

---

## 전체 요약
- **마이그레이션:** `fix_rls_security_audit` 1건 적용
- **제거:** 과도한 `authenticated_*` 정책 4개 (CRITICAL 보안 취약점)
- **추가:** admin 쓰기 정책 7개 (sites 3 + parts 3 + payrolls 1)
- **Supabase 보안 어드바이저:** RLS 경고 0건
- **프로덕션 보안 준비도:** ~95% → ~99%
