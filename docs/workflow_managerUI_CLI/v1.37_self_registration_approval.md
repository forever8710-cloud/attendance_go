# v1.37 — 근로자 자가 가입 요청 + 관리자 승인 워크플로우

**작업일**: 2026-02-24
**버전**: v1.37

---

## 개요

근로자가 Worker App에서 직접 가입 요청 → 관리자가 Manager Web에서 승인하는 셀프 서비스 등록 프로세스 구현.

기존: 관리자가 Manager Web에서 15개+ 필드를 직접 입력하여 근로자 등록
변경: 근로자가 앱에서 기본정보 입력 → 관리자 승인 → 나머지 정보 추가 입력

---

## 전체 플로우

```
[Worker App]                          [Manager Web]
1. OAuth 로그인 (카카오/구글)
2. 전화번호 입력 → workers 매칭 실패
3. "가입 요청하기" 버튼 표시
4. 가입 요청 폼: 이름/전화번호/주소/소속회사
5. 제출 → registration_requests INSERT
6. "승인 대기중" 화면                  7. 헤더 알림 뱃지 (N건)
                                      8. 클릭 → 대기 목록 다이얼로그
                                      9. 승인 → 센터/파트/직위/사번 입력
                                      10. Edge Function → workers + worker_profiles 생성
11. 앱 새로고침 → workers 매칭 성공 → 인증완료
```

---

## 변경사항

### DB 마이그레이션
- `registration_requests` 테이블 생성
  - `id`, `auth_user_id`, `name`, `phone`, `company`, `address`, `detail_address`
  - `status` ('pending', 'approved', 'rejected')
  - `reject_reason`, `reviewed_by`, `reviewed_at`
  - RLS: 본인 INSERT/SELECT + 관리자 SELECT/UPDATE

### Edge Function
- `approve-registration` 신규 배포
  - service_role로 workers + worker_profiles 원자적 생성
  - 실패 시 롤백 (create-auth-user 패턴)
  - JWT에서 reviewer ID 추출

### Worker App 수정
| 파일 | 변경 |
|------|------|
| `auth_provider.dart` | `AuthStatus.pendingApproval` 추가, `submitRegistration()`, `refreshApprovalStatus()` |
| `auth_repository.dart` | `checkPendingRegistration()`, `submitRegistration()` |
| `phone_verification_screen.dart` | 에러 시 "가입 요청하기" 버튼 추가 |
| `registration_form_screen.dart` (신규) | 이름/전화번호/주소/소속회사 입력 폼 |
| `pending_approval_screen.dart` (신규) | 승인 대기 안내 + 새로고침 + 로그아웃 |
| `main.dart` | `pendingApproval` → `PendingApprovalScreen` 라우팅 |

### Manager Web 수정
| 파일 | 변경 |
|------|------|
| `registration_repository.dart` (신규) | `getPendingRequests()`, `approveRequest()`, `rejectRequest()`, `getPendingCount()` |
| `registration_provider.dart` (신규) | `pendingRequestsProvider`, `pendingCountProvider` |
| `pending_requests_dialog.dart` (신규) | 대기 요청 리스트 + 승인/거부 버튼 |
| `approval_form_dialog.dart` (신규) | 센터/파트/직위/사번 입력 + Edge Function 호출 |
| `main.dart` | 헤더에 알림 아이콘 + 뱃지 추가 |

---

## 파일 목록

### 신규 (6개)
1. DB migration: `create_registration_requests`
2. Edge Function: `approve-registration`
3. `apps/worker_app/lib/features/auth/presentation/registration_form_screen.dart`
4. `apps/worker_app/lib/features/auth/presentation/pending_approval_screen.dart`
5. `apps/manager_web/lib/features/workers/data/registration_repository.dart`
6. `apps/manager_web/lib/features/workers/providers/registration_provider.dart`
7. `apps/manager_web/lib/features/workers/presentation/widgets/pending_requests_dialog.dart`
8. `apps/manager_web/lib/features/workers/presentation/widgets/approval_form_dialog.dart`

### 수정 (5개)
1. `apps/worker_app/lib/features/auth/providers/auth_provider.dart`
2. `apps/worker_app/lib/features/auth/data/auth_repository.dart`
3. `apps/worker_app/lib/features/auth/presentation/phone_verification_screen.dart`
4. `apps/worker_app/lib/main.dart`
5. `apps/manager_web/lib/main.dart`

---

## 추가 수정사항 (v1.37 후반)

### 1. 대기 요청 카드 폭 조정
- 근로자등록 화면의 가입 요청 카드가 화면 전체 폭으로 늘어나는 문제 수정
- `ConstrainedBox(maxWidth: 700)` + `Align(centerLeft)` 적용
- 파일: `workers_screen.dart`

### 2. 인사기록카드 수정/신규등록 기능 수정
- **문제**: 드롭다운이 근로자 전환 시 갱신되지 않음, 신규 근로자 INSERT 대신 UPDATE 호출
- **수정 내용**:
  - `_formKey` + `KeyedSubtree(key: ValueKey)` 패턴으로 드롭다운 강제 재빌드
  - `_loadWorkerData()`: `_job` 값 null 방어 (job ?? part 폴백)
  - `_saveWorker()`: 신규 → `createWorkerWithProfile()` / 기존 → `saveWorkerProfile()` 분기
  - `WorkersRepository.createWorkerWithProfile()` 메서드 신규 추가 (INSERT + select id)
  - `WorkersRepository.saveWorkerProfile()`: part 매핑 `worker.job ?? worker.part` 사용
- 파일: `workers_screen.dart`, `workers_repository.dart`

### 3. 승인 폼 직무 드롭다운 중복 제거
- "파트"와 "직무" 드롭다운이 동일 항목(지게차, 피커 등)을 표시하는 중복 문제
- "직무" 드롭다운 제거, 파트 선택값이 자동으로 job 필드에 저장
- 미사용 `_selectedJob`, `_jobs` 변수 정리
- 파일: `approval_form_dialog.dart`

---

## 파일 목록 (최종)

### 신규 (8개)
1. DB migration: `create_registration_requests`
2. Edge Function: `approve-registration`
3. `apps/worker_app/lib/features/auth/presentation/registration_form_screen.dart`
4. `apps/worker_app/lib/features/auth/presentation/pending_approval_screen.dart`
5. `apps/manager_web/lib/features/workers/data/registration_repository.dart`
6. `apps/manager_web/lib/features/workers/providers/registration_provider.dart`
7. `apps/manager_web/lib/features/workers/presentation/widgets/pending_requests_dialog.dart`
8. `apps/manager_web/lib/features/workers/presentation/widgets/approval_form_dialog.dart`

### 수정 (7개)
1. `apps/worker_app/lib/features/auth/providers/auth_provider.dart` — pendingApproval 상태
2. `apps/worker_app/lib/features/auth/data/auth_repository.dart` — 가입 요청 메서드
3. `apps/worker_app/lib/features/auth/presentation/phone_verification_screen.dart` — 가입 요청 버튼
4. `apps/worker_app/lib/main.dart` — pendingApproval 라우팅
5. `apps/manager_web/lib/main.dart` — 헤더 알림 뱃지 + 사이드네비 뱃지
6. `apps/manager_web/lib/features/workers/data/workers_repository.dart` — createWorkerWithProfile 추가
7. `apps/manager_web/lib/features/workers/presentation/workers_screen.dart` — 대기 카드 + 인사카드 수정

---

## 검증
- [x] DB migration 적용 완료
- [x] Edge Function 배포 완료
- [x] Worker App `flutter build web` 성공
- [x] Manager Web `flutter build web` 성공
- [x] Firebase 배포 완료 (myprojectjihun.web.app)
- [x] Chrome + Whale 브라우저 확인
- [x] 대기 카드 폭 축소 확인
- [x] 인사기록카드 수정/신규등록 확인
- [x] 승인 폼 직무 중복 제거 확인
