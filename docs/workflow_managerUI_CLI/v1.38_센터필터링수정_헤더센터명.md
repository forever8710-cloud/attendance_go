# v1.38 — 센터 필터링 수정 + 헤더 센터명 표시

**작업일**: 2026-02-25

---

## 변경 사항

### 1. 헤더 센터명 라벨 추가
- 날짜 좌측에 센터명 배지 추가 (Space Indigo 배경 + 건물 아이콘)
- system_admin / owner 로그인 → **"전체센터"**
- center_manager 로그인 → **"서이천센터"**, **"부평센터"** 등 해당 센터명
- `userSiteNameProvider` (FutureProvider) — sitesProvider에서 siteId→name 매핑

### 2. 근태현황 사이트 필터링 수정
- **문제**: center_manager 로그인 시 전체 센터의 근태 데이터가 노출됨
- **수정**: `attendance_records_provider.dart`에 `_effectiveSiteId()` 패턴 적용 (대시보드와 동일)
- **수정**: `attendance_records_repository.dart` 쿼리에 `.eq('workers.site_id', siteId)` 서버사이드 필터 추가

### 3. 급여관리 사이트 필터링 수정
- **문제**: `calculatePayroll(siteId, yearMonth)` — siteId 파라미터를 받지만 쿼리에서 사용하지 않음
- **수정**: `payroll_repository.dart`에서 `siteId`가 비어있지 않을 때 `.eq('site_id', siteId)` 필터 적용
- **수정**: `payroll_screen.dart`에서 `canAccessAllSites()` 패턴으로 siteId 결정

---

## 수정 파일

| 파일 | 변경 |
|------|------|
| `main.dart` | 헤더에 `_buildCenterLabel()` 추가, 날짜 좌측에 센터명 배지 |
| `dashboard_provider.dart` | `userSiteNameProvider` FutureProvider 추가 |
| `attendance_records_repository.dart` | `siteId` 파라미터를 실제 쿼리에 적용 |
| `attendance_records_provider.dart` | `_effectiveSiteId()` 헬퍼 + siteId 전달 로직 |
| `payroll_repository.dart` | workers 쿼리에 siteId 필터 적용 |
| `payroll_screen.dart` | `canAccessAllSites()` 패턴으로 siteId 결정 |

---

## 보안 점검 결과

| 화면 | 필터링 방식 | 상태 |
|------|------------|------|
| 대시보드 (출퇴근현황) | 서버사이드 (`_effectiveSiteId`) | OK |
| 근태현황 | 서버사이드 (`workers.site_id` 필터) | **수정 완료** |
| 근로자등록 | 클라이언트사이드 (role 기반) | OK |
| 급여관리 | 서버사이드 (`site_id` 필터) | **수정 완료** |
