# v1.42 — Worker App 로그인 플로우 수정 + 완전 삭제 + 계약형태 분리 + 테이블 개선 + 직책/직위 컬럼 분리 + 세션 유지

**작업일:** 2026-02-27

---

## 1. Worker App 로그인 플로우 수정

### 변경 전 문제
- OAuth 로그인 후 추가정보 입력창이 안 보임
- 관리자 웹에 등록 요청이 안 옴
- `restoreSession()`이 신규 사용자를 `needsPhoneVerification`으로 보내고 있었음

### 변경 후 플로우
1. **OAuth 로그인** (카카오/구글/SMS)
2. **개인정보 동의** (`needsConsent` → `ConsentScreen`)
3. **가입 요청 폼** (`needsProfileCompletion` → `RegistrationFormScreen`)
   - 이름 (카카오/구글 계정에서 자동 채우기)
   - 전화번호
   - 소속회사 (BT/TK)
   - 주소 (도로명주소 API)
   - 주민등록번호 (앞6자리 + 뒤7자리 마스킹)
   - 급여 계좌 (은행 선택 + 계좌번호)
4. **제출 → 승인 대기** (`pendingApproval` → `PendingApprovalScreen`)
5. **관리자 웹 승인** → Edge Function으로 workers + worker_profiles 생성
6. **인증 완료** (`authenticated` → `MainScaffold`)

### 변경 파일

#### Worker App
- `auth_provider.dart`
  - `restoreSession()`: 신규 OAuth → `needsConsent` (기존 `needsPhoneVerification`)
  - `acceptConsent()`: worker null → `needsProfileCompletion`, worker 존재 → `needsPermission`
  - `submitRegistration()`: ssn, bank, accountNumber 파라미터 추가
  - 에러/거부 상태 라우팅 수정
- `auth_repository.dart`: submitRegistration에 ssn, bank, account_number 필드 추가
- `main.dart`: needsProfileCompletion → worker null이면 RegistrationFormScreen
- `registration_form_screen.dart`
  - 주민등록번호 필드 (6+7 분리 입력, 뒷자리 obscureText)
  - 은행 드롭다운 (20개 은행)
  - 계좌번호 입력
  - OAuth 사용자 정보에서 이름/전화번호 자동 채우기 (`_prefillFromAuth()`)

#### Manager Web
- `registration_repository.dart`: RegistrationRequest 모델에 ssn, bank, accountNumber 추가
- `approval_form_dialog.dart`: 승인 폼에 주민번호(마스킹), 은행, 계좌번호 읽기 전용 표시

#### Edge Function
- `approve-registration/index.ts`: worker_profiles insert에 ssn, bank, account_number 전달

#### DB
- `registration_requests` 테이블에 ssn, bank, account_number 컬럼 추가

---

## 2. 근로자 완전 삭제 (system_admin 전용)

### 구현 내용
- `WorkersRepository.deleteWorkerPermanently()` 메서드 추가
- worker_profiles → attendances → payrolls → registration_requests → workers 순서로 삭제
- `WorkersScreen`에 "완전 삭제" 버튼 추가 (진한 빨간색, `Icons.delete_forever`)
- system_admin 역할에서만 표시
- 삭제 전 경고 다이얼로그 (삭제 대상 목록 표시, 되돌릴 수 없음 안내)

---

## 3. 계약형태 컬럼 분리

### 변경 전
- 재직상태 컬럼 1개에 계약형태(정규직/계약직/일용직/파견)와 재직상태(재직/퇴사)가 혼합

### 변경 후
- **계약형태** 컬럼: 정규직 / 계약직 / 일용직 / 파견 (employment_status 필드, 색상 뱃지)
- **재직상태** 컬럼: 재직 / 퇴사 (is_active 기반, 초록/회색 뱃지)

### 변경 파일
- `workers_screen.dart`
  - HR카드 폼: "재직상태" 드롭다운 라벨 → "계약형태"로 변경
  - 테이블 컬럼: "계약형태" + "재직상태" 2개 컬럼으로 분리
  - 필터: "계약형태" 필터 (정규직/계약직/일용직/파견) + "재직상태" 필터 (재직/퇴사) 분리
  - `_buildContractChip()`: 계약형태별 색상 뱃지 (정규직=초록, 계약직=파랑, 일용직=주황, 파견=보라)
  - `_buildStatusChip()`: 재직=초록, 퇴사=회색
  - `_saveWorker()`: isActive를 employmentStatus에서 파생하지 않고 기존 값 유지
- `worker_detail_screen.dart`
  - 근로자 상세 화면: "계약형태" + "재직상태" 필드 분리 표시

---

## 4. 근로자 테이블 개선

### 전화번호 하이픈 포맷팅
- 테이블 전화번호 컬럼에 `_formatPhone()` 적용
- `01034670422` → `010-3467-0422` 형태로 표시
- 11자리(010), 10자리(02/031 등) 모두 지원

### 전체 선택 + 일괄 수정
- 테이블 맨 왼쪽에 체크박스 컬럼 추가
- 헤더 체크박스: 전체 선택 / 전체 해제 (tristate 지원)
- 각 행 체크박스: 개별 선택/해제
- 선택 시 상단 액션 바 표시: "N명 선택됨" + **일괄 수정** 버튼 + **선택 해제** 버튼
- 일괄 수정 다이얼로그: 소속회사, 사업장, 직무, 직책, 직위, 상/저온, 계약형태, 재직상태 (8개 항목)
- 모든 드롭다운에 "선택없음" 옵션 → 변경하지 않을 항목 선택 해제 가능

### 변경 파일
- `workers_screen.dart`
  - `_checkedWorkerIds` Set 상태 변수 추가
  - `_formatPhone()`: 전화번호 하이픈 포맷 헬퍼
  - `_showBulkEditDialog()`: 일괄 수정 다이얼로그 (8개 항목)
  - `_buildBulkDropdown()`: 일괄수정 전용 드롭다운 (선택없음 포함)
  - `_executeBulkEdit()`: 선택된 근로자 일괄 저장 (named parameters)
  - 테이블 컬럼 0번에 Checkbox, 헤더에 전체선택 Checkbox
- `sticky_data_table.dart`
  - `TableColumnDef.labelWidget`: 헤더에 커스텀 위젯 지원 (Checkbox 등)
- `company_constants.dart`
  - `companyNames`, `companyCodeByName()` 헬퍼 메서드 추가

---

## 5. 직책/직위 컬럼 분리

### 변경 전
- 테이블에 "직위" 컬럼 1개에 직책(반장/조장/파트장)과 직위(사원/대리/과장/부장/대표) 데이터가 혼재

### 변경 후
- **직책** 컬럼: 반장 / 조장 / 파트장 (`role` 필드) — 직책 없으면 `-` 표시
- **직위** 컬럼: 사원 / 대리 / 과장 / 부장 / 대표 (`position` 필드)
- 테이블 총 14컬럼: 체크박스, No., 성명, 사업장, 소속회사, 사번, 전화번호, 직무, **직책**, **직위**, 상/저온, 계약형태, 재직상태, 입사일

### 변경 파일
- `workers_screen.dart`
  - 테이블 컬럼 "직책" + "직위" 분리 추가
  - cellBuilder: colIndex 8=`w.role`(직책), 9=`w.position`(직위)

---

## 6. 관리자 웹 로그인 세션 유지

### 변경 전 문제
- 새로고침(F5)할 때마다 로그인이 풀림
- `AuthNotifier`가 앱 시작 시 기존 Supabase 세션을 확인하지 않음

### 변경 후
- 앱 시작 시 `_restoreSession()` 자동 호출
- Supabase가 브라우저 localStorage에 저장한 세션 토큰 확인
- 세션 존재 → workers 테이블 조회 → 권한 확인 → 자동 로그인
- 세션 만료 → `refreshSession()`으로 토큰 갱신 시도
- 세션 복원 중 로딩 스피너 표시 (로그인 화면 깜빡임 방지)

### 변경 파일
- `auth_provider.dart` (Manager Web)
  - `_restoreSession()`: 기존 세션 확인 → workers 조회 → 자동 인증
  - `AuthNotifier` 생성자에서 자동 호출
- `main.dart`
  - `AuthStatus.initial` / `loading` 상태일 때 로딩 스피너 표시 (로그인 화면 대신)
