# v1.8 — 방안3 근태 비즈니스 로직 문서 업데이트

**작업일:** 2026-02-08
**범위:** `docs/workflow_proposal_md/` 4개 문서 전체 (v1.0 → v1.1)

---

## 배경

기존 PRD는 출근/퇴근 버튼만 다루고 있었으나, 실제 물류센터 현장에서는 점심시간 외출, 조퇴, 업무 중간 이탈 등 다양한 상황이 발생한다. 거래처 대표와 협의하여 MVP 범위를 **출근, 퇴근, 조퇴**까지로 확정하고, 외출/복귀는 출시 후 피드백 반영으로 결정.

## 방안3 (하이브리드) 핵심 설계

| 구분 | 트리거 | 처리 방식 |
|------|--------|-----------|
| 출근 | GPS 500m 진입 (자동) 또는 수동 버튼 | 자동 기록 + 푸시 알림 |
| 점심 | 관리자 설정 규칙 (예: 12:00~13:00) | 자동 차감, 근로자 조작 불필요 |
| 퇴근 | 정규시간 이후 + GPS 500m 이탈 (자동) 또는 수동 버튼 | 자동 기록 + 점심 차감 |
| 조퇴 | 앱에서 "조퇴" 버튼 + 사유 선택 | 수동 (MVP) |
| 외출/복귀 | GPS 이탈 + 사유 태그 | Post-MVP |

---

## 변경 파일 및 상세 내역

### 1. 01_PRD_WorkFlow.md (제품 요구사항)

**변경 섹션:**
- **5.1 제품 컨셉:** "2단계" → "최소 조작" 4단계 자동화
- **6.1.2 출퇴근 기록:** GPS 500m 자동감지 + 수동 병행, 점심시간 규칙 자동차감, 조퇴 버튼 (사유 선택)
- **6.1.3 실시간 대시보드:** 조퇴 근로자 목록 추가
- **6.1.4 급여 관리:** 점심 차감 반영, 조퇴일수 추가
- **6.2 Post-MVP:** 외출/복귀 GPS 추적 (6.2.1) 신규 추가
- **7.1 시나리오 A:** 자동 출근, 점심 자동처리, 조퇴, 자동 퇴근 시나리오
- **9.1 우선순위:** Must Have에 조퇴, 점심규칙 추가 / Should Have에 외출/복귀 추가
- **10.1 기술 제약:** GPS 반경 100m → 500m

### 2. 02_TRD_WorkFlow.md (기술 요구사항)

**변경 섹션:**
- **2.2.1 데이터 플로우:** 자동 출근, 수동 출근, 조퇴 3가지 플로우로 분리
- **2.2.2 급여대장 플로우:** 점심시간 차감 로직, 조퇴일 점심 미차감 로직 추가
- **4.1 ERD:** sites에 lunch/work 필드, attendances에 자동감지/조퇴/점심차감 필드 추가
- **4.2.1 sites 스키마:**
  - `radius` DEFAULT 500
  - `lunch_start` TIME DEFAULT '12:00:00'
  - `lunch_end` TIME DEFAULT '13:00:00'
  - `lunch_duration` INTEGER DEFAULT 60
  - `work_start` TIME DEFAULT '07:00:00'
  - `work_end` TIME DEFAULT '17:00:00'
- **4.2.4 attendances 스키마:**
  - `is_auto_check_in` BOOLEAN
  - `is_auto_check_out` BOOLEAN
  - `check_out_reason` VARCHAR ('normal', 'early_leave')
  - `early_leave_reason` VARCHAR
  - `lunch_deducted` BOOLEAN
  - `net_work_hours` DECIMAL (점심 차감 후)
  - status에 `early_leave` 추가
- **4.3.1 트리거:** 점심시간 차감 로직 (사업장 lunch_duration 조회, 조퇴 시 점심 전이면 미차감)
- **5.2.3 조퇴 API:** 신규 추가
- **5.4.1 급여 계산:** 응답에 netWorkHours, earlyLeaveDays, site_lunch_rule 추가

### 3. 03_UserFlow_WorkFlow.md (사용자 행동 흐름)

**변경 섹션:**
- **1.2 범위:** 조퇴, 점심시간 자동차감 추가
- **2.2 출근:** 자동(2.2.1 GPS Geofencing) + 수동(2.2.2 버튼) 분리, 반경 500m
- **2.3 퇴근:** 자동(2.3.1 정규시간 후 이탈) + 수동(2.3.2 버튼) 분리, 점심시간 이탈 무시
- **2.4 조퇴:** 신규 섹션 (조퇴 버튼 → 사유 선택 → 점심 차감 판정 → 완료)
- **2.5 근태 기록 조회:** (기존 2.4에서 번호 변경)
- **에러 메시지:** EARLY_LEAVE_SUCCESS, EARLY_LEAVE_NO_REASON, AUTO_CHECK_IN, AUTO_CHECK_OUT 추가
- **화면 전환 매트릭스:** 조퇴 사유 선택, 조퇴 완료 행 추가
- GPS 반경 100m → 500m 전체 치환

### 4. 04_PromptDesign_WorkFlow.md (개발 프롬프트)

**변경 섹션:**
- **Milestone 3 (DB 스키마):** sites 점심/근무시간 필드, attendances 조퇴/자동감지 필드, 트리거 점심차감
- **Milestone 4 (모델):** Attendance 필드 확장 (isAuto, checkOutReason, earlyLeaveReason, lunchDeducted, netWorkHours), AttendanceStatus에 earlyLeave, CheckOutReason enum
- **Milestone 7 (GPS):** 기본 반경 500m
- **Milestone 8 (출근):** Geofencing 자동 출근 서비스 추가, 조퇴 버튼 UI, geofencing_service.dart 산출물 추가
- **Milestone 9 (퇴근→퇴근+조퇴):** earlyLeave 메서드, 자동 퇴근 감지, 조퇴 플로우(사유 선택 다이얼로그), early_leave_dialog.dart 산출물 추가
- **Milestone 14 (급여 계산):** netWorkHours 기준 계산, 점심 차감 총시간, 조퇴일수 집계, PayrollData에 netWorkHours/earlyLeaveDays 추가

---

## MVP 범위 정리

| 기능 | MVP | Post-MVP |
|------|-----|----------|
| GPS 500m 자동 출근 | O | |
| GPS 500m 자동 퇴근 (정규시간 이후) | O | |
| 수동 출근/퇴근 버튼 | O | |
| 점심시간 규칙 자동 차감 | O | |
| 조퇴 (사유 선택) | O | |
| 법적 동의 수집 (위치정보/개인정보) | O | |
| 동의 거부 시 수동 출퇴근 모드 | O | |
| 개인정보 처리방침 화면 | O | |
| 동의 철회 기능 (설정) | O | |
| 외출/복귀 GPS 추적 | | O |
| 외출 시 푸시 알림 + 사유 태그 | | O |
| 외출 시간 비급여 처리 | | O |

---

## 법적 준수 사항 (추가 반영)

### 적용 법률

| 법률 | 핵심 조항 | WorkFlow 대응 |
|------|----------|---------------|
| 위치정보법 제15조 | 개인위치정보 수집 시 개별 동의 필수 | 앱 최초 실행 시 동의 화면 (별도 체크박스) |
| 위치정보법 제18조 | 동의 범위 초과 이용 금지 | 출퇴근 시점 GPS만 수집, 실시간 추적 없음 |
| 개인정보보호법 | 수집 최소화, 동의서 고지 | 개인정보 동의 별도 수집, 처리방침 공개 |
| 근참법 | 감시 설비 노사 협의 | 목적·대상·방법 사전 합의 |

### 동의서 필수 포함 항목 (위치정보법)

1. 수집·이용 목적 (출퇴근 기록, 근태 관리, 급여 계산)
2. 수집 항목 (GPS 좌표, 수집 시각)
3. 보유·이용 기간 (근로관계 종료 후 3년)
4. 동의 거부 권리 + 거부 시 대안 (수동 출퇴근)

### 위반 시 처벌

- 무단 수집: 3년 이하 징역 / 3천만원 이하 벌금
- 범위 초과 이용: 5년 이하 징역 / 5천만원 이하 벌금

### 문서별 반영 내역

| 문서 | 추가/변경 내용 |
|------|---------------|
| 01_PRD | 6.1.1 법적 동의 수집 기능 추가, 10.2 법적 리스크 섹션 신설 |
| 02_TRD | workers 동의 필드, consent_logs 테이블, 6.2 법적 준수 섹션 보강, 동의 관리 API |
| 03_UserFlow | 로그인 후 동의 화면 Flow, 화면 전환 매트릭스 업데이트 |
| 04_PromptDesign | Milestone 4.5 (동의 수집 시스템) 신규, consent_log 모델, DB 스키마 보강 |
